<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QUANTUM OMEGA: v4.2 (Stable 1.5 Core)</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@300;400;500;600;700&family=Orbitron:wght@400;700;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body { background-color: #050505; color: #e2e8f0; font-family: 'Chakra Petch', sans-serif; overflow: hidden; }
        .font-sci { font-family: 'Orbitron', sans-serif; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        
        #starfield { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; opacity: 0.6; }
        
        .glass { background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.15); }
        .glass-card { background: rgba(30, 41, 59, 0.4); border: 1px solid rgba(255, 255, 255, 0.1); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .glass-card:hover { border-color: var(--theme-color, rgba(34, 211, 238, 0.4)); box-shadow: 0 0 20px var(--theme-shadow, rgba(34, 211, 238, 0.1)); }

        .neon-text { text-shadow: 0 0 10px var(--theme-glow, rgba(34, 211, 238, 0.6)); }
        
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--theme-color, rgba(34, 211, 238, 0.3)); border-radius: 10px; }

        @keyframes scanline { 0% { transform: translateY(-100%); } 100% { transform: translateY(100%); } }
        .scanline { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100; opacity: 0.05; overflow: hidden; }
        .scanline::after { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 2px; background: var(--theme-color, #22d3ee); animation: scanline 6s linear infinite; }
        
        .prose { font-size: 0.85rem; color: #94a3b8; line-height: 1.6; }
        .prose strong { color: var(--theme-color, #22d3ee); }
        .prose code { background: rgba(0,0,0,0.3); padding: 2px 4px; border-radius: 4px; color: #f472b6; }

        .chart-container { position: relative; height: 100%; width: 100%; min-height: 250px; }
        
        /* Sidebar Animations */
        .sidebar-overlay { transition: opacity 0.3s ease, visibility 0.3s; }
        .sidebar-content { transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .sidebar-open { opacity: 1; visibility: visible; pointer-events: auto; }
        .sidebar-open .sidebar-content { transform: translateX(0); }
        .sidebar-closed { opacity: 0; visibility: hidden; pointer-events: none; }
        .sidebar-closed .sidebar-content { transform: translateX(-100%); }

        .ai-pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 var(--theme-shadow, rgba(34, 211, 238, 0.4)); } 70% { box-shadow: 0 0 0 10px rgba(34, 211, 238, 0); } 100% { box-shadow: 0 0 0 0 rgba(34, 211, 238, 0); } }

        /* Theme Classes */
        .theme-cyan { --theme-color: #22d3ee; --theme-shadow: rgba(34, 211, 238, 0.4); --theme-glow: rgba(34, 211, 238, 0.6); }
        .theme-green { --theme-color: #4ade80; --theme-shadow: rgba(74, 222, 128, 0.4); --theme-glow: rgba(74, 222, 128, 0.6); }
        .theme-pink { --theme-color: #f472b6; --theme-shadow: rgba(244, 114, 182, 0.4); --theme-glow: rgba(244, 114, 182, 0.6); }
        .theme-amber { --theme-color: #fbbf24; --theme-shadow: rgba(251, 191, 36, 0.4); --theme-glow: rgba(251, 191, 36, 0.6); }
        
        /* Panic Mode Blur */
        .panic-blur { filter: blur(8px) grayscale(80%); transition: filter 2s; }
        
        /* Custom Checkbox */
        .cb-custom { appearance: none; background-color: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); width: 16px; height: 16px; border-radius: 4px; display: grid; place-content: center; transition: all 0.2s; }
        .cb-custom::before { content: ""; width: 10px; height: 10px; transform: scale(0); transition: 120ms transform ease-in-out; box-shadow: inset 1em 1em var(--theme-color); transform-origin: center; clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%); }
        .cb-custom:checked::before { transform: scale(1); }
        .cb-custom:checked { border-color: var(--theme-color); }

        /* Force Dark Option for Selects */
        select { background-color: #050b18 !important; color: #e2e8f0 !important; }
        option { background-color: #050b18 !important; color: #e2e8f0 !important; padding: 10px; }
        
        /* TradingView Widget Hack */
        .tradingview-widget-container iframe { border: none !important; }

        /* Calendar Grid */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
    </style>
</head>
<body class="theme-cyan">

    <canvas id="starfield"></canvas>
    <div class="scanline"></div>
    <div id="root"></div>

    <script>
        // Starfield Animation
        const initStarfield = () => {
            const canvas = document.getElementById('starfield');
            const ctx = canvas.getContext('2d');
            let width, height, stars = [], particles = [];
            const resize = () => {
                width = window.innerWidth; height = window.innerHeight;
                canvas.width = width; canvas.height = height;
                stars = [];
                for(let i=0; i<(width*height/4000); i++) stars.push({ x: Math.random()*width-width/2, y: Math.random()*height-height/2, z: Math.random()*width, o: Math.random() });
            };
            window.triggerExplosion = (x, y, color) => {
                for(let i=0; i<30; i++) particles.push({ x: x||width/2, y: y||height/2, vx: (Math.random()-0.5)*10, vy: (Math.random()-0.5)*10, life: 1.0, color: color||'#22d3ee' });
            };
            const draw = () => {
                ctx.fillStyle = '#050505'; ctx.fillRect(0,0,width,height);
                const cx = width/2, cy = height/2, speed = 1.5 + (window.warpActive?40:0);
                stars.forEach(s => {
                    s.z -= speed;
                    if (s.z <= 0) { s.z = width; s.x = Math.random()*width-width/2; s.y = Math.random()*height-height/2; }
                    const x = (s.x/s.z)*width+cx, y = (s.y/s.z)*height+cy, size = (1-s.z/width)*2.5, alpha = (1-s.z/width)*s.o;
                    if (x>=0 && x<width && y>=0 && y<height) {
                        ctx.beginPath(); ctx.fillStyle = `rgba(200, 245, 255, ${alpha})`; ctx.arc(x,y,size>0?size:0,0,Math.PI*2); ctx.fill();
                        if(window.warpActive) { ctx.beginPath(); ctx.strokeStyle = `rgba(6,182,212,${alpha*0.3})`; ctx.moveTo(x,y); ctx.lineTo(cx+(s.x/(s.z+50))*width, cy+(s.y/(s.z+50))*height); ctx.stroke(); }
                    }
                });
                particles.forEach((p,i) => {
                    p.x+=p.vx; p.y+=p.vy; p.life-=0.02;
                    if(p.life<=0) particles.splice(i,1);
                    else { ctx.globalAlpha = p.life; ctx.fillStyle = p.color; ctx.beginPath(); ctx.arc(p.x,p.y,3,0,Math.PI*2); ctx.fill(); ctx.globalAlpha=1; }
                });
                requestAnimationFrame(draw);
            };
            window.addEventListener('resize', resize); resize(); draw();
        };
        initStarfield();
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, Fragment } = React;
        const fmt = (n) => n ? n.toLocaleString('en-US', { style: 'currency', currency: 'USD' }) : '$0.00';

        // --- TRANSLATIONS / DICTIONARY ---
        const TRANSLATIONS = {
            en: {
                nav_terminal: 'Battle Station',
                nav_journal: 'Mission Logs',
                nav_neural: 'Neural Link',
                nav_stats: 'Deep Analytics',
                nav_news: 'News Feed',
                nav_chart: 'Market Chart',
                nav_calendar: 'PnL Calendar',
                nav_zen: 'Zen Focus',
                data_profile: 'Data & Profile',
                btn_import: 'Import Backup',
                btn_backup: 'Backup All Data',
                btn_new: 'New',
                btn_delete: 'Delete',
                stat_pf: 'Profit Factor',
                stat_disc: 'Avg Discipline',
                stat_wins: 'Wins',
                stat_losses: 'Losses',
                stat_dd: 'Max Drawdown',
                stat_surv: 'Survival Prob',
                head_day: 'Day',
                head_start: 'Start',
                head_setup: 'Setup',
                head_asset: 'Asset',
                head_action: 'Action',
                head_strat: 'Strategy',
                head_grade: 'Grade',
                head_mood: 'Mood',
                head_log: 'Log',
                head_end: 'End Bal',
                head_img: 'Img',
                lbl_start_cap: 'Start Capital',
                lbl_start_date: 'Start Date',
                lbl_risk_pct: 'Risk %',
                lbl_target_rr: 'Target RR',
                lbl_duration: 'Duration',
                lbl_sl_pips: 'Est. SL (Pips)',
                lbl_target: 'Target',
                lbl_cashout: 'Cash Out',
                lbl_reward: 'Reward Extraction',
                btn_win: 'WIN',
                btn_loss: 'LOSS',
                btn_forecast: 'Forecast',
                btn_ai_analysis: 'Initiate AI Analysis',
                modal_risk: 'Tactical Risk',
                modal_check: 'Launch Sequence',
                modal_check_ready: 'System Ready',
                modal_check_btn: 'Complete Checks',
                modal_log: "Captain's Log",
                modal_img: 'Target Evidence',
                txt_global_liq: 'Global Liquidity',
                txt_ai_strat: 'AI Strategy',
                txt_time_dilation: 'Time Dilation Simulator',
                txt_future_val: 'Future Value',
                txt_perf_matrix: 'Daily Performance Matrix',
                txt_neural_dna: 'Neural DNA',
                txt_win_rate: 'Win Rate',
                txt_mission_consist: 'Mission Consistency',
                txt_connect_core: 'Connect to Quantum Core for Strategic Insight',
                lang_sel: 'Language / ภาษา',
                status_open: 'OPEN',
                status_closed: 'CLOSED',
                status_thai_time: 'TH Time',
                cal_mon: 'Mon', cal_tue: 'Tue', cal_wed: 'Wed', cal_thu: 'Thu', cal_fri: 'Fri', cal_sat: 'Sat', cal_sun: 'Sun',
                cl_news: 'Check High Impact News?',
                cl_levels: 'Identify Key Levels (S/R)?',
                cl_trend: 'Confirm Trend Direction?',
                cl_candle: 'Wait for Candle Close?',
                cl_rr: 'Risk Reward > 1:1.5?',
                cl_sl: 'Stop Loss Calculated?',
                cl_risk: 'Accept the Risk?',
                mood_neutral: 'Neutral',
                mood_confident: 'Confident',
                mood_anxious: 'Anxious',
                mood_fomo: 'FOMO',
                mood_revenge: 'Revenge',
                mood_disciplined: 'Disciplined',
                mood_hesitant: 'Hesitant',
                st_trend_following: 'Trend Following',
                st_reversal: 'Reversal',
                st_breakout: 'Breakout',
                st_scalping: 'Scalping',
                st_news_trade: 'News Trade',
                st_other: 'Other'
            },
            th: {
                nav_terminal: 'สถานีรบ (Terminal)',
                nav_journal: 'บันทึกภารกิจ (Logs)',
                nav_neural: 'ระบบประสาท (Neural)',
                nav_stats: 'วิเคราะห์เชิงลึก (Stats)',
                nav_news: 'ข่าวกรอง (News)',
                nav_chart: 'กราฟราคา (Chart)',
                nav_calendar: 'ปฏิทินกำไร (Calendar)',
                nav_zen: 'โหมดสมาธิ (Zen)',
                data_profile: 'ข้อมูล & โปรไฟล์',
                btn_import: 'นำเข้าข้อมูลสำรอง',
                btn_backup: 'สำรองข้อมูลทั้งหมด',
                btn_new: 'สร้างใหม่',
                btn_delete: 'ลบ',
                stat_pf: 'ตัวคูณกำไร (PF)',
                stat_disc: 'วินัยเฉลี่ย',
                stat_wins: 'ชนะ',
                stat_losses: 'แพ้',
                stat_dd: 'ขาดทุนสูงสุด (DD)',
                stat_surv: 'โอกาสรอด',
                head_day: 'วัน',
                head_start: 'ทุนเริ่ม',
                head_setup: 'ตั้งค่า',
                head_asset: 'สินทรัพย์',
                head_action: 'สถานะ',
                head_strat: 'กลยุทธ์',
                head_grade: 'เกรด',
                head_mood: 'อารมณ์',
                head_log: 'โน้ต',
                head_end: 'คงเหลือ',
                head_img: 'รูป',
                lbl_start_cap: 'เงินทุนเริ่มต้น',
                lbl_start_date: 'วันที่เริ่มภารกิจ',
                lbl_risk_pct: 'ความเสี่ยง %',
                lbl_target_rr: 'เป้าหมาย RR',
                lbl_duration: 'ระยะเวลา (วัน)',
                lbl_sl_pips: 'SL โดยประมาณ (Pips)',
                lbl_target: 'เป้าหมาย',
                lbl_cashout: 'ถอนออก',
                lbl_reward: 'รางวัลความสำเร็จ',
                btn_win: 'ชนะ',
                btn_loss: 'แพ้',
                btn_forecast: 'พยากรณ์',
                btn_ai_analysis: 'เริ่มวิเคราะห์ด้วย AI',
                modal_risk: 'คำนวณความเสี่ยง',
                modal_check: 'ขั้นตอนเตรียมเทรด',
                modal_check_ready: 'ระบบพร้อม',
                modal_check_btn: 'ตรวจสอบให้ครบ',
                modal_log: 'บันทึกกัปตัน',
                modal_img: 'หลักฐานเป้าหมาย',
                txt_global_liq: 'สภาพคล่องรวม',
                txt_ai_strat: 'กลยุทธ์ AI',
                txt_time_dilation: 'จำลองผลตอบแทน (Time Dilation)',
                txt_future_val: 'มูลค่าในอนาคต',
                txt_perf_matrix: 'เมทริกซ์ผลงานรายวัน',
                txt_neural_dna: 'รหัสพันธุกรรมเทรดเดอร์',
                txt_win_rate: 'อัตราการชนะ',
                txt_mission_consist: 'ความสม่ำเสมอของภารกิจ',
                txt_connect_core: 'เชื่อมต่อ Quantum Core เพื่อรับคำแนะนำเชิงกลยุทธ์',
                lang_sel: 'Language / ภาษา',
                status_open: 'เปิด',
                status_closed: 'ปิด',
                status_thai_time: 'เวลาไทย',
                cal_mon: 'จันทร์', cal_tue: 'อังคาร', cal_wed: 'พุธ', cal_thu: 'พฤหัส', cal_fri: 'ศุกร์', cal_sat: 'เสาร์', cal_sun: 'อาทิตย์',
                cl_news: 'เช็คข่าวแรง (High Impact)?',
                cl_levels: 'หาแนวรับแนวต้าน (S/R)?',
                cl_trend: 'ยืนยันทิศทางเทรนด์?',
                cl_candle: 'รอจบแท่งเทียน?',
                cl_rr: 'ความคุ้มค่า > 1:1.5?',
                cl_sl: 'คำนวณ Stop Loss แล้ว?',
                cl_risk: 'ยอมรับความเสี่ยงได้?',
                mood_neutral: 'เฉยๆ / ปกติ',
                mood_confident: 'มั่นใจ',
                mood_anxious: 'กังวล',
                mood_fomo: 'กลัวตกรถ (FOMO)',
                mood_revenge: 'อยากเอาคืน',
                mood_disciplined: 'มีวินัย',
                mood_hesitant: 'ลังเล',
                st_trend_following: 'ตามเทรนด์',
                st_reversal: 'สวนเทรนด์ (Reversal)',
                st_breakout: 'เบรคเอาท์',
                st_scalping: 'ปั้นพอร์ต (Scalping)',
                st_news_trade: 'ชนข่าว',
                st_other: 'อื่นๆ'
            }
        };

        // Sound Engine
        const playSound = (type, enabled) => {
            if (!enabled) return;
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain); gain.connect(ctx.destination);
            if (type === 'win') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(523.25, ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(1046.50, ctx.currentTime+0.1);
                gain.gain.setValueAtTime(0.1, ctx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime+0.4);
                osc.start(); osc.stop(ctx.currentTime+0.4);
            } else if (type === 'loss') {
                osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, ctx.currentTime);
                gain.gain.setValueAtTime(0.1, ctx.currentTime); gain.gain.linearRampToValueAtTime(0, ctx.currentTime+0.3);
                osc.start(); osc.stop(ctx.currentTime+0.3);
            } else if (type === 'click') {
                osc.type = 'square'; osc.frequency.setValueAtTime(800, ctx.currentTime);
                gain.gain.setValueAtTime(0.05, ctx.currentTime); gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime+0.1);
                osc.start(); osc.stop(ctx.currentTime+0.1);
            }
        };

        // Icons
        const Icon = ({ p, s=18, c="currentColor", cls="" }) => (
            <svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke={c} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={cls}>{p}</svg>
        );
        const Paths = {
            Atom: <g><circle cx="12" cy="12" r="1"/><path d="M20.2 20.2c2.04-2.03.02-7.36-4.5-11.9-4.54-4.52-9.87-6.54-11.9-4.5-2.04 2.03-.02 7.36 4.5 11.9 4.54 4.52 9.87 6.54 11.9 4.5Z"/><path d="M15.7 15.7c4.52-4.54 6.54-9.87 4.5-11.9-2.03-2.04-7.36-.02-11.9 4.5-4.52 4.54-6.54 9.87-4.5 11.9 2.03 2.04 7.36.02 11.9-4.5Z"/></g>,
            Terminal: <g><polyline points="4 17 10 11 4 5"/><line x1="12" y1="19" x2="20" y2="19"/></g>,
            Chart: <g><path d="M3 3v18h18"/><path d="M18.7 8l-5.1 5.2-2.8-2.7L7 14.3"/></g>,
            Brain: <g><path d="M9.5 2A5 5 0 0 1 12 4.5a5 5 0 0 1 2.5-2.5 5 5 0 0 1 0 10 5 5 0 0 1-5 0 5 5 0 0 1 0-10z"/><path d="M12 4.5V12"/><path d="M12 12a5 5 0 0 1-2.5 2.5 5 5 0 0 1-5-5 5 5 0 0 1 2.5 7.5z"/></g>,
            Pulse: <polyline points="22 12 18 12 15 21 9 3 6 12 2 12" />,
            Send: <g><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></g>,
            Plus: <g><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></g>,
            Journal: <g><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></g>,
            Check: <polyline points="20 6 9 17 4 12" />,
            X: <g><line x1="18" y1="6" x2="6" y2="18" /><line x1="6" y1="6" x2="18" y2="18" /></g>,
            Menu: <g><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></g>,
            Calculator: <g><rect x="4" y="2" width="16" height="20" rx="2"></rect><line x1="8" y1="6" x2="16" y2="6"></line><line x1="16" y1="14" x2="16" y2="14"></line><line x1="12" y1="14" x2="12" y2="14"></line><line x1="8" y1="14" x2="8" y2="14"></line><line x1="16" y1="18" x2="16" y2="18"></line><line x1="12" y1="18" x2="12" y2="18"></line><line x1="8" y1="18" x2="8" y2="18"></line></g>,
            Camera: <g><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></g>,
            Shield: <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>,
            Rocket: <g><path d="M4.5 16.5c-1.5 1.26-2 5-2 5s3.74-.5 5-2c.71-.84.7-2.13-.09-2.91a2.18 2.18 0 0 0-2.91-.09z"/><path d="m12 15-3-3a22 22 0 0 1 2-3.95A12.88 12.88 0 0 1 22 2c0 2.72-.78 7.5-6 11a22.35 22.35 0 0 1-4 2z"/><path d="M9 12H4s.55-3.03 2-4c1.62-1.08 5 0 5 0"/><path d="M12 15v5s3.03-.55 4-2c1.08-1.62 0-5 0-5"/></g>,
            Alert: <g><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></g>,
            Clock: <g><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></g>,
            Edit: <g><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></g>,
            Gift: <g><polyline points="20 12 20 22 4 22 4 12"/><rect x="2" y="7" width="20" height="5"/><line x1="12" y1="22" x2="12" y2="7"/><path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z"/><path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z"/></g>,
            Close: <g><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></g>,
            Csv: <g><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><path d="M10 12l-2 2 2 2"/><path d="M14 12l2 2-2 2"/></g>,
            Excel: <g><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="8" y1="13" x2="16" y2="13"/><line x1="8" y1="17" x2="16" y2="17"/><polyline points="10 9 9 9 8 9"/></g>,
            Import: <g><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></g>,
            Grid: <g><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></g>,
            ArrowDownToLine: <g><line x1="12" y1="17" x2="12" y2="3"/><path d="M6 11l6 6 6-6"/><path d="M19 21H5"/></g>,
            SoundOn: <g><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></g>,
            SoundOff: <g><line x1="1" y1="1" x2="23" y2="23"></line><path d="M9 9v6a17.91 17.91 0 0 1-5-5"></path><path d="M11 5L6 9H2v6h4l5 4v-5"></path></g>,
            Export: <g><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></g>,
            Globe: <circle cx="12" cy="12" r="10"></circle>,
            Image: <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>,
            Calendar: <g><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></g>,
            ArrowLeft: <line x1="19" y1="12" x2="5" y2="12"></line>,
            ArrowRight: <line x1="5" y1="12" x2="19" y2="12"></line>
        };

        const STRATEGIES = ["Trend Following", "Reversal", "Breakout", "Scalping", "News Trade", "Other"];
        const MOODS = ["Neutral", "Confident", "Anxious", "FOMO", "Revenge", "Disciplined", "Hesitant"];
        const ASSETS = ["XAUUSD", "BTCUSD", "EURUSD", "GBPUSD", "US30", "NAS100", "Stocks", "Other"];
        const GRADES = ["A", "B", "C", "F"];
        const THEMES = [
            { id: 'theme-cyan', name: 'Cyberpunk' },
            { id: 'theme-green', name: 'Matrix' },
            { id: 'theme-pink', name: 'Vaporwave' },
            { id: 'theme-amber', name: 'Gold' }
        ];

        // CHECKLIST ITEMS
        const CHECKLIST_KEYS = [
            "cl_news", "cl_levels", "cl_trend", "cl_candle", "cl_rr", "cl_sl", "cl_risk"
        ];

        // --- UPDATED API CALL FUNCTION (Fixed: Using specific version -001 to resolve 'not found' error) ---
        const callGeminiLLM = async (messages, systemPrompt, userKey) => {
            if(!userKey) throw new Error("Please enter API Key in the settings.");
            
            // Fix: Changed 'gemini-1.5-flash' to 'gemini-1.5-flash-001' (Pinned version is more stable for API detection)
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-001:generateContent?key=${userKey}`;
            
            const payload = {
                contents: messages,
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    temperature: 0.7,
                    maxOutputTokens: 1000
                }
            };

            try {
                const res = await fetch(url, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify(payload) 
                });

                if(!res.ok) {
                    const errorData = await res.json().catch(() => ({}));
                    console.error("API Error Data:", errorData);
                    throw new Error(errorData.error?.message || `API Connection Failed: ${res.status}`);
                }

                const data = await res.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "Neural Link Error: No data received.";
            } catch (error) {
                console.error("Neural Link Error:", error);
                throw error;
            }
        };

        const RiskCalculator = ({ active, close, t }) => {
            const [sl, setSl] = useState(50);
            const [risk, setRisk] = useState(100); 
            const [pair, setPair] = useState('XAUUSD');
            
            const getLot = () => {
                const pipVal = pair === 'XAUUSD' ? 1 : 10; 
                const res = risk / (sl * pipVal);
                return res.toFixed(2);
            };

            if(!active) return null;

            return (
                <div 
                    className="fixed inset-0 z-[200] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 animate-fade-in cursor-pointer"
                    onClick={close} 
                >
                    <div 
                        className="glass-card p-6 rounded-3xl w-full max-w-xs border border-[var(--theme-color)]/30 relative shadow-2xl cursor-default"
                        onClick={e => e.stopPropagation()} 
                    >
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="text-sm font-bold text-[var(--theme-color)] uppercase flex items-center gap-2"><Icon p={Paths.Shield} s={16}/> {t('modal_risk')}</h3>
                            <button onClick={close} className="hover:text-white text-slate-400 transition-colors p-2 rounded-full hover:bg-white/10"><Icon p={Paths.Close} s={18}/></button>
                        </div>
                        <div className="space-y-4 mb-6">
                            <div className="flex justify-between items-center text-xs">
                                <span className="text-slate-300 font-bold">Risk ($)</span>
                                <input type="number" value={risk} onChange={e=>setRisk(parseFloat(e.target.value))} className="w-24 bg-slate-900 border border-white/10 rounded-lg px-2 py-1 text-right text-white outline-none focus:border-[var(--theme-color)] font-mono"/>
                            </div>
                            <div className="flex justify-between items-center text-xs">
                                <span className="text-slate-300 font-bold">SL (Pips)</span>
                                <input type="number" value={sl} onChange={e=>setSl(parseFloat(e.target.value))} className="w-24 bg-slate-900 border border-white/10 rounded-lg px-2 py-1 text-right text-white outline-none focus:border-[var(--theme-color)] font-mono"/>
                            </div>
                            <div className="flex justify-between items-center text-xs">
                                <span className="text-slate-300 font-bold">Pair</span>
                                <select value={pair} onChange={e=>setPair(e.target.value)} className="w-24 bg-slate-900 border border-white/10 rounded-lg px-2 py-1 text-right text-white outline-none text-[10px] focus:border-[var(--theme-color)]">
                                    <option value="EURUSD">Currencies</option>
                                    <option value="XAUUSD">Gold/XAU</option>
                                </select>
                            </div>
                        </div>
                        <div className="p-4 bg-[var(--theme-color)]/10 rounded-2xl text-center border border-[var(--theme-color)]/20">
                            <div className="text-[9px] uppercase text-slate-400 font-bold tracking-widest mb-1">Suggested Lot Size</div>
                            <div className="text-4xl font-mono font-bold text-[var(--theme-color)] text-shadow">{getLot()}</div>
                        </div>
                    </div>
                </div>
            );
        };

        const ChecklistModal = ({ active, close, t }) => {
            const [checked, setChecked] = useState({});
            useEffect(() => { if(active) setChecked({}); }, [active]);
            const toggle = (idx) => setChecked(p => ({...p, [idx]: !p[idx]}));
            const allChecked = CHECKLIST_KEYS.every((_, i) => checked[i]);
            if(!active) return null;
            return (
                 <div className="fixed inset-0 z-[200] bg-black/90 backdrop-blur-md flex items-center justify-center p-4 animate-fade-in" onClick={close}>
                    <div className="glass-card p-8 rounded-3xl w-full max-w-md border border-[var(--theme-color)] shadow-[0_0_50px_rgba(0,0,0,0.8)] relative" onClick={e=>e.stopPropagation()}>
                        <h2 className="text-xl font-sci font-bold text-[var(--theme-color)] mb-6 flex items-center gap-3 uppercase tracking-widest"><Icon p={Paths.Rocket} s={24}/> {t('modal_check')}</h2>
                        <div className="space-y-3 mb-8">
                            {CHECKLIST_KEYS.map((key, i) => (
                                <label key={i} className="flex items-center gap-4 p-3 rounded-xl bg-white/5 hover:bg-white/10 cursor-pointer transition-all border border-transparent hover:border-[var(--theme-color)]/30 group">
                                    <input type="checkbox" checked={!!checked[i]} onChange={()=>toggle(i)} className="cb-custom" />
                                    <span className={`text-xs font-mono transition-all ${checked[i] ? 'text-[var(--theme-color)] line-through opacity-50' : 'text-slate-300'}`}>{t(key)}</span>
                                </label>
                            ))}
                        </div>
                        <button onClick={close} disabled={!allChecked} className={`w-full py-4 rounded-xl font-bold uppercase tracking-[0.2em] transition-all flex items-center justify-center gap-2 ${allChecked ? 'bg-[var(--theme-color)] text-black shadow-[0_0_20px_var(--theme-shadow)] hover:scale-105' : 'bg-slate-800 text-slate-500 cursor-not-allowed'}`}>
                            {allChecked ? <span>{t('modal_check_ready')} <Icon p={Paths.Check} s={16}/></span> : t('modal_check_btn')}
                        </button>
                    </div>
                 </div>
            );
        };

        const SessionClocks = React.memo(({ t }) => {
            const [time, setTime] = useState(new Date());
            useEffect(() => { const i = setInterval(() => setTime(new Date()), 1000); return () => clearInterval(i); }, []);
            
            const getSession = (offset, openH, closeH, name) => {
                const d = new Date();
                const utc = d.getTime() + (d.getTimezoneOffset() * 60000);
                const cityTime = new Date(utc + (3600000 * offset));
                const h = cityTime.getHours();
                const isOpen = h >= openH && h < closeH;
                const diff = 7 - offset;
                let tOpen = (openH + diff + 24) % 24;
                let tClose = (closeH + diff + 24) % 24;
                const fmt = (t) => `${t.toString().padStart(2,'0')}:00`;
                return { name, t: cityTime.toLocaleTimeString('en-US', {hour:'2-digit', minute:'2-digit', hour12:false}), isOpen, range: `${fmt(tOpen)}-${fmt(tClose)}` };
            };

            const ldn = getSession(1, 8, 17, 'LDN'); const ny = getSession(-4, 8, 17, 'NY'); const tky = getSession(9, 9, 16, 'TKY'); const bkk = getSession(7, 0, 0, 'BKK'); 

            return (
                <div className="hidden md:flex items-center gap-6 text-[9px] font-mono">
                    {[ldn, ny, tky].map(c => (
                        <div key={c.name} className={`flex flex-col items-center transition-all ${c.isOpen ? 'opacity-100 scale-105' : 'opacity-60'}`}>
                            <div className="flex items-center gap-1 mb-0.5">
                                <span className={`font-bold tracking-wider ${c.isOpen ? 'text-[var(--theme-color)]' : 'text-slate-500'}`}>{c.name}</span>
                                <div className={`w-1.5 h-1.5 rounded-full ${c.isOpen ? 'bg-emerald-400 animate-pulse shadow-[0_0_5px_#34d399]' : 'bg-rose-500'}`}></div>
                            </div>
                            <span className="text-xs font-bold text-white mb-0.5">{c.t}</span>
                            <div className="flex flex-col items-center">
                                <span className={`px-1.5 py-0.5 rounded text-[8px] font-bold uppercase mb-0.5 ${c.isOpen ? 'bg-emerald-500/20 text-emerald-400' : 'bg-slate-700/50 text-slate-500'}`}>{c.isOpen ? t('status_open') : t('status_closed')}</span>
                                <span className="text-[8px] text-slate-500 whitespace-nowrap mt-0.5">{c.range}</span>
                            </div>
                        </div>
                    ))}
                    <div className="h-8 w-px bg-white/10 mx-2"></div>
                    <div className="flex flex-col items-center">
                        <span className="font-bold tracking-wider text-slate-400 mb-0.5">BKK</span>
                        <span className="text-xl font-bold text-white leading-none">{bkk.t}</span>
                        <span className="text-[8px] text-[var(--theme-color)] mt-1">{t('status_thai_time')}</span>
                    </div>
                </div>
            );
        });

        const ThemeSwitcher = ({ current, set }) => (
            <div className="flex gap-1">
                {THEMES.map(t => (
                    <button key={t.id} onClick={() => set(t.id)} className={`w-4 h-4 rounded-full border border-white/10 transition-all ${t.id === 'theme-cyan' ? 'bg-[#22d3ee]' : t.id === 'theme-green' ? 'bg-[#4ade80]' : t.id === 'theme-pink' ? 'bg-[#f472b6]' : 'bg-[#fbbf24]'} ${current===t.id ? 'ring-2 ring-white scale-110' : 'opacity-50 hover:opacity-100'}`} title={t.name}></button>
                ))}
            </div>
        );

        const PanicOverlay = ({ active, close }) => {
            const [step, setStep] = useState(0);
            const [count, setCount] = useState(4);
            useEffect(() => {
                if(!active) return;
                const timer = setInterval(() => { setCount(c => { if (c === 1) { setStep(s => (s + 1) % 3); return 4; } return c - 1; }); }, 1000);
                return () => clearInterval(timer);
            }, [active]);
            if(!active) return null;
            const text = step === 0 ? "INHALE" : step === 1 ? "HOLD" : "EXHALE";
            return (
                <div className="fixed inset-0 z-[300] bg-black/90 backdrop-blur-xl flex flex-col items-center justify-center text-center animate-fade-in">
                    <h1 className="text-4xl md:text-6xl font-sci text-red-500 font-bold mb-8 animate-pulse">PANIC PROTOCOL ENGAGED</h1>
                    <div className="w-64 h-64 border-4 border-red-500/30 rounded-full flex items-center justify-center relative mb-8">
                        <div className={`absolute inset-0 bg-red-500/10 rounded-full transition-all duration-[4000ms] ${step===0 ? 'scale-100' : 'scale-50'}`}></div>
                        <div className="text-5xl font-mono font-bold text-white relative z-10">{text}</div>
                    </div>
                    <div className="text-2xl font-mono text-red-400 mb-12">{count}</div>
                    <button onClick={close} className="px-8 py-3 border border-white/10 rounded-xl text-slate-400 hover:text-white hover:bg-white/5 transition-all">DISENGAGE</button>
                </div>
            );
        };

        // --- NEW: PnL Calendar Component ---
        const PnLCalendar = ({ cur, stats, t, lang }) => {
            const [viewDate, setViewDate] = useState(new Date());

            const tradeMap = useMemo(() => {
                const map = {};
                if (!cur.config.startDate) return map;
                
                const start = new Date(cur.config.startDate);
                stats.rows.forEach(row => {
                    if (row.status !== 'pending') {
                        const d = new Date(start);
                        d.setDate(d.getDate() + (row.day - 1));
                        const key = d.toISOString().split('T')[0];
                        map[key] = row;
                    }
                });
                return map;
            }, [cur.config.startDate, stats.rows]);

            const daysInMonth = new Date(viewDate.getFullYear(), viewDate.getMonth() + 1, 0).getDate();
            const firstDay = new Date(viewDate.getFullYear(), viewDate.getMonth(), 1).getDay();
            
            // Adjust for Mon start (0-6 Sun-Sat -> 1-7 Mon-Sun)
            const adjustedFirstDay = firstDay === 0 ? 6 : firstDay - 1; 

            const monthName = viewDate.toLocaleDateString(lang === 'th' ? 'th-TH' : 'en-US', { month: 'long', year: 'numeric' });

            const changeMonth = (delta) => {
                const newDate = new Date(viewDate);
                newDate.setMonth(newDate.getMonth() + delta);
                setViewDate(newDate);
            };

            const dayNames = ['cal_mon', 'cal_tue', 'cal_wed', 'cal_thu', 'cal_fri', 'cal_sat', 'cal_sun'];

            return (
                <div className="h-full animate-fade-in flex flex-col pb-24 lg:pb-0 overflow-hidden">
                    <div className="glass-card flex-1 rounded-3xl p-6 flex flex-col border border-white/10">
                        {/* Header */}
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-2xl font-sci font-bold text-[var(--theme-color)] uppercase tracking-wider flex items-center gap-3">
                                <Icon p={Paths.Calendar} s={24}/> {t('nav_calendar')}
                            </h2>
                            <div className="flex items-center gap-4">
                                <button onClick={() => changeMonth(-1)} className="p-2 rounded-lg bg-white/5 hover:bg-[var(--theme-color)]/20 hover:text-[var(--theme-color)] transition-all"><Icon p={<path d="M15 18l-6-6 6-6"/>} s={20}/></button>
                                <span className="text-xl font-mono font-bold text-white min-w-[150px] text-center capitalize">{monthName}</span>
                                <button onClick={() => changeMonth(1)} className="p-2 rounded-lg bg-white/5 hover:bg-[var(--theme-color)]/20 hover:text-[var(--theme-color)] transition-all"><Icon p={<path d="M9 18l6-6-6-6"/>} s={20}/></button>
                            </div>
                        </div>

                        {/* Calendar Grid */}
                        <div className="flex-1 flex flex-col min-h-0">
                            {/* Days Header */}
                            <div className="grid grid-cols-7 mb-2">
                                {dayNames.map(d => (
                                    <div key={d} className="text-center text-[10px] font-bold text-slate-500 uppercase tracking-widest py-2">
                                        {t(d)}
                                    </div>
                                ))}
                            </div>
                            
                            {/* Days Cells */}
                            <div className="flex-1 grid grid-cols-7 grid-rows-6 gap-2">
                                {Array.from({ length: adjustedFirstDay }).map((_, i) => (
                                    <div key={`empty-${i}`} className="bg-transparent"></div>
                                ))}
                                {Array.from({ length: daysInMonth }).map((_, i) => {
                                    const dayNum = i + 1;
                                    const dateStr = new Date(viewDate.getFullYear(), viewDate.getMonth(), dayNum + 1).toISOString().split('T')[0];
                                    const trade = tradeMap[dateStr];
                                    
                                    let bgClass = "bg-white/5 border-white/5";
                                    let textClass = "text-slate-500";
                                    let pnlClass = "text-slate-600";
                                    
                                    if (trade) {
                                        if (trade.pnl > 0) {
                                            bgClass = "bg-emerald-500/10 border-emerald-500/30 hover:bg-emerald-500/20";
                                            pnlClass = "text-emerald-400";
                                        } else if (trade.pnl < 0) {
                                            bgClass = "bg-rose-500/10 border-rose-500/30 hover:bg-rose-500/20";
                                            pnlClass = "text-rose-400";
                                        } else {
                                            bgClass = "bg-slate-500/10 border-slate-500/30";
                                            pnlClass = "text-slate-400";
                                        }
                                        textClass = "text-white";
                                    }

                                    return (
                                        <div key={dayNum} className={`rounded-xl border p-2 flex flex-col justify-between transition-all relative group ${bgClass}`}>
                                            <div className={`text-xs font-bold font-mono ${textClass}`}>{dayNum}</div>
                                            {trade && (
                                                <div className="text-right">
                                                    <div className={`text-sm md:text-lg font-bold font-mono ${pnlClass}`}>
                                                        {trade.pnl > 0 ? '+' : ''}{fmt(trade.pnl).replace('$','')}
                                                    </div>
                                                    <div className="text-[8px] uppercase font-bold opacity-70 tracking-wider">
                                                        {trade.status === 'win' ? t('btn_win') : t('btn_loss')}
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const TimeDilation = ({ t }) => {
            const [bal, setBal] = useState(1000);
            const [rate, setRate] = useState(1);
            const [days, setDays] = useState(30);
            const future = bal * Math.pow((1 + rate/100), days);
            return (
                <div className="glass-card p-4 rounded-3xl col-span-1 md:col-span-2 relative overflow-hidden">
                    <div className="absolute top-0 right-0 p-4 opacity-10"><Icon p={Paths.Calculator} s={48} /></div>
                    <h3 className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-3 flex items-center gap-2"><Icon p={Paths.Clock} s={14}/> {t('txt_time_dilation')}</h3>
                    <div className="flex gap-4 items-end mb-4">
                        <div className="flex-1"><label className="text-[8px] uppercase text-slate-500 font-bold">Start</label><input type="number" value={bal} onChange={e=>setBal(parseFloat(e.target.value)||0)} className="w-full bg-transparent border-b border-white/10 text-xs py-1 text-white font-mono outline-none"/></div>
                        <div className="flex-1"><label className="text-[8px] uppercase text-slate-500 font-bold">% Daily</label><input type="number" value={rate} onChange={e=>setRate(parseFloat(e.target.value)||0)} className="w-full bg-transparent border-b border-white/10 text-xs py-1 text-[var(--theme-color)] font-mono outline-none"/></div>
                        <div className="flex-1"><label className="text-[8px] uppercase text-slate-500 font-bold">Days</label><input type="number" value={days} onChange={e=>setDays(parseFloat(e.target.value)||0)} className="w-full bg-transparent border-b border-white/10 text-xs py-1 text-white font-mono outline-none"/></div>
                    </div>
                    <div className="text-right">
                        <div className="text-[9px] uppercase text-slate-500 tracking-widest">{t('txt_future_val')}</div>
                        <div className="text-2xl font-mono font-bold text-white text-shadow">{fmt(future)}</div>
                        <div className="text-[9px] text-[var(--theme-color)]">+{fmt(future-bal)} (Compounded)</div>
                    </div>
                </div>
            );
        };

        const CaptainLogModal = ({ isOpen, onClose, log, saveLog, t }) => {
            const [text, setText] = useState(log);
            useEffect(() => setText(log), [log]);
            if(!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[150] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
                    <div className="bg-[#0f172a] border border-white/10 rounded-2xl w-full max-w-lg p-6 shadow-2xl relative">
                        <h3 className="text-sm font-bold uppercase text-[var(--theme-color)] mb-4 flex items-center gap-2"><Icon p={Paths.Edit} s={16}/> {t('modal_log')}</h3>
                        <textarea value={text} onChange={e=>setText(e.target.value)} className="w-full h-40 bg-black/30 border border-white/5 rounded-xl p-3 text-xs text-slate-300 outline-none focus:border-[var(--theme-color)] font-mono" placeholder="Enter mission notes..."></textarea>
                        <div className="flex justify-end gap-2 mt-4">
                            <button onClick={onClose} className="px-4 py-2 rounded-lg text-xs text-slate-500 hover:text-white">Cancel</button>
                            <button onClick={()=>{saveLog(text); onClose();}} className="px-4 py-2 rounded-lg text-xs bg-[var(--theme-color)] text-black font-bold">Save Log</button>
                        </div>
                    </div>
                </div>
            );
        };

        const ImageModal = ({ isOpen, onClose, url, onSave, t }) => {
            const [inputUrl, setInputUrl] = useState(url || '');
            useEffect(() => setInputUrl(url || ''), [url]);
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[160] bg-black/90 backdrop-blur-md flex items-center justify-center p-4" onClick={onClose}>
                    <div className="glass-card p-6 rounded-3xl w-full max-w-2xl border border-[var(--theme-color)] relative flex flex-col gap-4" onClick={e=>e.stopPropagation()}>
                        <h3 className="text-sm font-bold uppercase text-[var(--theme-color)] flex items-center gap-2"><Icon p={Paths.Camera} s={16}/> {t('modal_img')}</h3>
                        <input type="text" value={inputUrl} onChange={e=>setInputUrl(e.target.value)} placeholder="Paste Image URL here (e.g., TradingView link)" className="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-2 text-xs text-white outline-none focus:border-[var(--theme-color)]" />
                        {inputUrl && <div className="rounded-xl overflow-hidden border border-white/10 bg-black/20 aspect-video flex items-center justify-center relative">
                            <img src={inputUrl} alt="Evidence" className="max-w-full max-h-full object-contain" onError={(e)=>{e.target.style.display='none'}}/>
                            <div className="absolute inset-0 -z-10 flex items-center justify-center text-slate-600 text-xs">Preview Area</div>
                        </div>}
                        <div className="flex justify-end gap-2">
                            <button onClick={onClose} className="px-4 py-2 rounded-lg text-xs text-slate-500 hover:text-white">Close</button>
                            <button onClick={()=>{onSave(inputUrl); onClose();}} className="px-4 py-2 rounded-lg text-xs bg-[var(--theme-color)] text-black font-bold">Save Evidence</button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- NEW: MARKET CHART (TradingView Embedded) ---
        const MarketChart = ({ theme, lang }) => {
            const container = useRef();
            
            useEffect(() => {
                if(!container.current) return;
                container.current.innerHTML = "";
                const script = document.createElement("script");
                script.src = "https://s3.tradingview.com/tv.js";
                script.async = true;
                script.onload = () => {
                    if(window.TradingView) {
                        new window.TradingView.widget({
                            "width": "100%",
                            "height": "100%",
                            "symbol": "OANDA:XAUUSD", 
                            "interval": "60",
                            "timezone": "Asia/Bangkok",
                            "theme": "dark",
                            "style": "1",
                            "locale": lang === 'th' ? "th_TH" : "en",
                            "toolbar_bg": "#f1f3f6",
                            "enable_publishing": false,
                            "hide_side_toolbar": false,
                            "allow_symbol_change": true,
                            "save_image": true,
                            "details": true,
                            "calendar": true,
                            "container_id": "tradingview_chart"
                        });
                    }
                };
                container.current.appendChild(script);
            }, [lang]); 

            return (
                <div className="h-full animate-fade-in flex flex-col pb-24 lg:pb-0">
                    <div className="glass-card w-full h-full rounded-3xl overflow-hidden border border-white/10">
                        <div id="tradingview_chart" ref={container} style={{height: '100%', width: '100%'}}></div>
                    </div>
                </div>
            );
        };

        // --- News Terminal (Economic Calendar) ---
        const NewsTerminal = ({ lang }) => {
            const container = useRef();
            
            useEffect(() => {
                if(!container.current) return;
                container.current.innerHTML = "";
                const script = document.createElement("script");
                script.src = "https://s3.tradingview.com/external-embedding/embed-widget-events.js";
                script.type = "text/javascript";
                script.async = true;
                script.innerHTML = JSON.stringify({
                    "colorTheme": "dark",
                    "isTransparent": true,
                    "width": "100%",
                    "height": "100%",
                    "locale": lang === 'th' ? "th_TH" : "en",
                    "currencyFilter": "USD,EUR,GBP,JPY,XAU,CAD,AUD"
                });
                container.current.appendChild(script);
            }, [lang]);

            return (
                <div className="h-full animate-fade-in flex flex-col pb-24 lg:pb-0">
                    <div className="glass-card w-full h-full rounded-3xl overflow-hidden border border-white/10">
                        <div className="tradingview-widget-container" ref={container} style={{height: '100%', width: '100%'}}>
                            <div className="tradingview-widget-container__widget" style={{height: '100%', width: '100%'}}></div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- CORE COMPONENTS ---

        const Heatmap = ({ stats, days, t }) => {
            return (
                <div className="glass-card p-5 rounded-3xl flex flex-col md:col-span-4">
                    <h3 className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-4 flex items-center gap-2"><Icon p={Paths.Grid} s={14}/> {t('txt_mission_consist')} (Heatmap)</h3>
                    <div className="flex flex-wrap gap-1 justify-start">
                        {Array.from({length: days}).map((_, i) => {
                            const dayNum = i + 1; const trade = stats.rows.find(r => r.day === dayNum);
                            let bgClass = "bg-white/5"; let glowClass = "";
                            if (trade) { if (trade.status === 'win') { bgClass = "bg-[var(--theme-color)]"; glowClass = "shadow-[0_0_10px_var(--theme-shadow)]"; } else if (trade.status === 'loss') { bgClass = "bg-rose-500"; } }
                            return ( <div key={dayNum} className={`w-6 h-6 rounded-sm ${bgClass} ${glowClass} transition-all hover:scale-125 hover:z-10 cursor-default relative group`}>
                                <div className="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 hidden group-hover:block bg-black text-xs p-2 rounded whitespace-nowrap z-20 border border-white/20">Day {dayNum}: {trade?.status === 'pending' ? 'Pending' : (trade?.status || 'No Trade')}</div>
                            </div> )
                        })}
                    </div>
                </div>
            )
        };

        const TradeChart = ({ equityData, highWaterMark }) => {
            const chartRef = useRef(null); const canvasRef = useRef(null);
            useEffect(() => {
                if (!canvasRef.current) return;
                const ctx = canvasRef.current.getContext('2d');
                if (chartRef.current) chartRef.current.destroy();
                const style = getComputedStyle(document.body);
                const themeColor = style.getPropertyValue('--theme-color').trim() || '#22d3ee';
                const gradient = ctx.createLinearGradient(0, 0, 0, 400); gradient.addColorStop(0, themeColor + '66'); gradient.addColorStop(1, themeColor + '00');
                const labels = equityData.map(d => d.x); const data = equityData.map(d => d.y); const hwmData = highWaterMark.map(d => d.y);
                chartRef.current = new Chart(ctx, { type: 'line', data: { labels: labels, datasets: [ { label: 'Equity Curve', data: data, borderColor: themeColor, backgroundColor: gradient, borderWidth: 2, fill: true, tension: 0.4, pointRadius: 3, pointHoverRadius: 6, pointBackgroundColor: '#050505', pointBorderColor: themeColor }, { label: 'High-Water Mark', data: hwmData, borderColor: 'rgba(255, 255, 255, 0.2)', borderWidth: 1, borderDash: [5, 5], fill: false, pointRadius: 0, tension: 0.1 } ] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false, backgroundColor: 'rgba(15, 23, 42, 0.95)', titleColor: '#e2e8f0', bodyColor: themeColor, borderColor: 'rgba(255,255,255,0.2)', borderWidth: 1 } }, scales: { x: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#94a3b8' } }, y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#94a3b8', callback: (v) => '$'+v } } }, interaction: { mode: 'nearest', axis: 'x', intersect: false } } });
                return () => { if (chartRef.current) chartRef.current.destroy(); };
            }, [equityData, highWaterMark]);
            return <div className="chart-container"><canvas ref={canvasRef}></canvas></div>;
        };

        const RadarDNA = ({ stats, cur, t }) => {
            const s = 140, c = 70, r = 50;
            const points = [ { l: 'Win%', v: stats.wr }, { l: 'PF', v: Math.min(100, stats.pf*33) }, { l: 'Disc', v: (stats.avgDisc/5)*100 }, { l: 'R:R', v: Math.min(100, cur.config.rr*25) }, { l: 'XP', v: stats.progress } ];
            const poly = points.map((p, i) => { const a = (Math.PI*2*i)/5 - Math.PI/2; const val = (p.v/100) * r; return `${c + val*Math.cos(a)},${c + val*Math.sin(a)}`; }).join(' ');
            return (
                <div className="flex flex-col items-center glass-card p-4 rounded-2xl">
                    <span className="text-[10px] font-bold text-[var(--theme-color)] uppercase tracking-widest mb-4">{t('txt_neural_dna')}</span>
                    <svg width={s} height={s} className="overflow-visible"> <polygon points={poly} fill="var(--theme-shadow)" stroke="var(--theme-color)" strokeWidth="2" /> {[0.5, 1].map(scale => ( <circle key={scale} cx={c} cy={c} r={r*scale} fill="none" stroke="rgba(255,255,255,0.05)" strokeWidth="1" /> ))} </svg>
                    <div className="mt-4 grid grid-cols-2 gap-2 w-full text-[8px] text-slate-500 uppercase font-bold"> {points.map(p=><div key={p.l}>{p.l}: {p.v.toFixed(0)}</div>)} </div>
                </div>
            );
        };

        const RewardCard = ({ cur, updateCur, fmt, isSound, t }) => {
            const [amount, setAmount] = useState('');
            const handleExtract = () => { const val = parseFloat(amount); if(!val || val <= 0) return; const newWithdrawn = (cur.withdrawn || 0) + val; updateCur('withdrawn', newWithdrawn); setAmount(''); if(window.triggerExplosion) window.triggerExplosion(window.innerWidth/2, window.innerHeight/2, '#ec4899'); playSound('win', isSound); };
            const progress = Math.min(100, (cur.withdrawn/cur.goal.amount)*100);
            return (
                <div className="glass-card p-4 rounded-3xl flex flex-col relative overflow-hidden group/card">
                    <div className="absolute top-0 left-0 w-full h-0.5 bg-gradient-to-r from-transparent via-pink-500 to-transparent opacity-50"></div>
                    <div className="flex items-center gap-2 text-pink-500 mb-4"> <Icon p={Paths.Gift} s={16} /> <h2 className="font-bold tracking-wider text-[10px] uppercase">{t('lbl_reward')}</h2> </div>
                    <div className="space-y-1 mb-5">
                        <div className="flex justify-between items-end text-[9px] font-bold text-slate-400 mb-1"> <span>{cur.goal.name}</span> <span className="text-white font-mono">{fmt(cur.withdrawn)} / {fmt(cur.goal.amount)}</span> </div>
                        <div className="h-1.5 w-full bg-[#13161f] rounded-full overflow-hidden border border-white/10 shadow-inner group relative">
                            <div className="absolute inset-0 bg-pink-500/10 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                            <div className="h-full bg-gradient-to-r from-pink-500 to-purple-600 transition-all duration-1000 shadow-[0_0_10px_rgba(236,72,153,0.5)] relative" style={{width: `${progress}%`}}> <div className="absolute right-0 top-0 bottom-0 w-[1px] bg-white/50 shadow-[0_0_5px_white]"></div> </div>
                        </div>
                    </div>
                    <div className="flex flex-col gap-2">
                        <div className="bg-[#0b0e14]/80 border border-white/10 rounded-xl px-3 py-2 flex items-center justify-between group focus-within:border-pink-500/50 transition-colors"> <label className="text-[8px] font-bold text-slate-500 uppercase tracking-wider">{t('lbl_target')}</label> <input type="number" value={cur.goal.amount} onChange={e=>updateCur('goal', {...cur.goal, amount:parseFloat(e.target.value)||0})} className="w-20 bg-transparent text-white font-mono font-bold text-xs outline-none text-right" /> </div>
                        <div className="flex gap-2 h-12">
                            <div className="flex-1 bg-[#0b0e14]/80 border border-white/10 rounded-xl px-3 py-1.5 flex flex-col justify-center relative focus-within:border-pink-500/50 transition-colors"> <label className="text-[8px] font-bold text-slate-500 uppercase tracking-wider mb-0.5">{t('lbl_cashout')}</label> <div className="flex items-center"> <span className="text-slate-500 font-mono mr-1 text-xs">$</span> <input type="number" value={amount} onChange={(e) => setAmount(e.target.value)} className="w-full bg-transparent text-slate-200 font-mono font-bold text-sm outline-none placeholder-slate-700" placeholder="0.00" onKeyDown={e => e.key === 'Enter' && handleExtract()} /> </div> </div>
                            <button onClick={handleExtract} className="aspect-square h-full bg-pink-600 hover:bg-pink-500 text-white rounded-xl flex items-center justify-center shadow-lg shadow-pink-900/20 active:scale-95 transition-all border border-pink-400/20"> <Icon p={Paths.ArrowDownToLine} s={20} /> </button>
                        </div>
                    </div>
                </div>
            );
        };

        const MissionLog = ({ cur, stats, updateCur, commitTrade, updateTradeDetail, t, isMobile }) => {
            const [openLogId, setOpenLogId] = useState(null);
            const [openImgId, setOpenImgId] = useState(null);
            
            // --- Mobile Card View ---
            if (isMobile) {
                return (
                    <div className="flex flex-col h-full animate-fade-in pb-24">
                        <div className="grid grid-cols-2 gap-4 mb-4 glass p-4 rounded-xl border border-white/5">
                            {[ 
                                {l:t('lbl_start_cap'),k:'bal', type: 'number'}, 
                                {l:t('lbl_risk_pct'),k:'risk', type: 'number'},
                                {l:t('lbl_start_date'), k:'startDate', type: 'date'}
                            ].map(f=>(
                                <div key={f.k}><label className="text-[8px] uppercase font-bold text-slate-400 block mb-1">{f.l}</label><input type={f.type} value={cur.config[f.k] || (f.k==='slPips'?50:'')} onChange={e=>updateCur('config', {...cur.config, [f.k]: f.type==='number'?parseFloat(e.target.value)||0:e.target.value})} className="bg-transparent border-b border-white/10 text-xs w-full outline-none text-white focus:border-[var(--theme-color)] font-mono"/></div>
                            ))}
                        </div>
                        <div className="space-y-4">
                            {stats.rows.map(row => (
                                <div key={row.day} className={`glass-card p-4 rounded-2xl flex flex-col gap-3 border ${row.status==='win'?'border-[var(--theme-color)]/30 bg-[var(--theme-color)]/5': row.status==='loss' ? 'border-rose-500/30 bg-rose-500/5' : 'border-white/10'}`}>
                                    <div className="flex justify-between items-center">
                                        <span className="font-bold text-[var(--theme-color)] text-sm">Day {row.day}</span>
                                        <span className="text-xs text-white font-mono">{fmt(row.startBal)}</span>
                                    </div>
                                    <div className="grid grid-cols-2 gap-2">
                                        <select className="bg-slate-900 border border-white/10 rounded-lg p-2 text-xs text-white" value={row.asset||""} onChange={(e)=>updateTradeDetail(row.day, 'asset', e.target.value)}>
                                            <option value="">- {t('head_asset')} -</option>
                                            {ASSETS.map(a=><option key={a} value={a}>{a}</option>)}
                                        </select>
                                        <select className="bg-slate-900 border border-white/10 rounded-lg p-2 text-xs text-white" value={row.strategy||""} onChange={(e)=>updateTradeDetail(row.day, 'strategy', e.target.value)}>
                                            <option value="">- {t('head_strat')} -</option>
                                            {STRATEGIES.map(s=><option key={s} value={s}>{t('st_'+s.replace(' ','_').toLowerCase())}</option>)}
                                        </select>
                                    </div>
                                    <div className="flex gap-2">
                                        <button onClick={()=>commitTrade(row.day,'win')} className={`flex-1 py-2 rounded-lg font-bold text-xs ${row.status==='win'?'bg-[var(--theme-color)] text-black':'bg-slate-800 text-slate-400'}`}>{t('btn_win')}</button>
                                        <button onClick={()=>commitTrade(row.day,'loss')} className={`flex-1 py-2 rounded-lg font-bold text-xs ${row.status==='loss'?'bg-rose-500 text-white':'bg-slate-800 text-slate-400'}`}>{t('btn_loss')}</button>
                                    </div>
                                    <div className="flex justify-between items-center pt-2 border-t border-white/5">
                                        <div className="flex gap-2">
                                            <button onClick={()=>setOpenLogId(row.day)} className="p-2 rounded-lg bg-white/5 text-slate-400"><Icon p={Paths.Edit} s={14}/></button>
                                            <button onClick={()=>setOpenImgId(row.day)} className={`p-2 rounded-lg ${row.screenshot ? 'text-amber-400 bg-amber-500/10' : 'text-slate-400 bg-white/5'}`}><Icon p={Paths.Camera} s={14}/></button>
                                        </div>
                                        <div className={`font-mono font-bold ${row.status==='win'?'text-[var(--theme-color)]':row.status==='loss'?'text-rose-400':'text-slate-600'}`}>{row.status!=='pending'?fmt(row.endBal):'-'}</div>
                                    </div>
                                </div>
                            ))}
                        </div>
                        <CaptainLogModal isOpen={!!openLogId} onClose={()=>setOpenLogId(null)} log={openLogId ? (cur.journal[openLogId]?.log || "") : ""} saveLog={(txt)=>updateTradeDetail(openLogId, 'log', txt)} t={t} />
                        <ImageModal isOpen={!!openImgId} onClose={()=>setOpenImgId(null)} url={openImgId ? (cur.journal[openImgId]?.screenshot || "") : ""} onSave={(url)=>updateTradeDetail(openImgId, 'screenshot', url)} t={t} />
                    </div>
                );
            }

            // --- Desktop Table View ---
            return (
                <div className="flex flex-col h-full animate-fade-in pb-24 lg:pb-0">
                    <div className="grid grid-cols-2 md:grid-cols-6 gap-4 mb-4 glass p-4 rounded-xl border border-white/5 items-end">
                        {[ 
                            {l:t('lbl_start_cap'),k:'bal', type: 'number'}, 
                            {l:t('lbl_risk_pct'),k:'risk', type: 'number'}, 
                            {l:t('lbl_target_rr'),k:'rr', type: 'number'}, 
                            {l:t('lbl_duration'),k:'days', type: 'number'}, 
                            {l:t('lbl_sl_pips'), k:'slPips', type: 'number'}
                        ].map(f=>(
                            <div key={f.k}><label className="text-[8px] uppercase font-bold text-slate-400 block mb-1">{f.l}</label><input type={f.type} value={cur.config[f.k] || (f.k==='slPips'?50:'')} onChange={e=>updateCur('config', {...cur.config, [f.k]: parseFloat(e.target.value)||0})} className="bg-transparent border-b border-white/10 text-xs w-full outline-none text-white focus:border-[var(--theme-color)] font-mono"/></div>
                        ))}
                        {/* Start Date Input */}
                         <div>
                            <label className="text-[8px] uppercase font-bold text-slate-400 block mb-1">{t('lbl_start_date')}</label>
                            <input type="date" value={cur.config.startDate || ""} onChange={e=>updateCur('config', {...cur.config, startDate: e.target.value})} className="bg-transparent border-b border-white/10 text-xs w-full outline-none text-white focus:border-[var(--theme-color)] font-mono"/>
                        </div>
                    </div>
                    <div className="flex-1 glass rounded-xl overflow-auto border border-white/10 no-scrollbar relative">
                        <table className="w-full text-left text-[10px] font-mono">
                            <thead className="sticky top-0 bg-[#050b18] z-10 border-b border-white/10 shadow-lg">
                                <tr className="uppercase text-slate-400 font-bold bg-white/5">
                                    <th className="p-4">{t('head_day')}</th>
                                    <th className="p-4 text-right">{t('head_start')}</th>
                                    <th className="p-4 text-center">{t('head_setup')}</th>
                                    <th className="p-4 text-center">{t('head_asset')}</th>
                                    <th className="p-4 text-center">{t('head_action')}</th>
                                    <th className="p-4 text-center">{t('head_strat')}</th> 
                                    <th className="p-4 text-center">{t('head_grade')}</th>
                                    <th className="p-4 text-center">{t('head_mood')}</th>
                                    <th className="p-4 text-center">{t('head_log')}</th>
                                    <th className="p-4 text-center">{t('head_img')}</th>
                                    <th className="p-4 text-right">{t('head_end')}</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-white/5">
                                {stats.rows.map(row => (
                                    <tr key={row.day} className={`group transition-colors ${row.status==='win'?'bg-[var(--theme-color)]/10': row.status==='loss' ? 'bg-rose-500/10' : 'hover:bg-white/5'}`}>
                                        <td className="p-4 text-slate-400 font-bold border-r border-white/5">{row.day}</td>
                                        <td className="p-4 text-right text-white font-bold">{fmt(row.startBal)}</td>
                                        <td className="p-4">
                                            <div className="flex flex-col items-center gap-1">
                                                <div className="text-amber-400 font-bold text-[9px] bg-amber-900/20 px-1 rounded">Lot: {row.lotSize.toFixed(2)}</div>
                                                <div className="flex gap-2 text-[8px] opacity-80">
                                                    <span className="text-rose-400">SL: -{fmt(row.riskAmt)}</span>
                                                    <span className="text-[var(--theme-color)]">TP: +{fmt(row.rewardAmt)}</span>
                                                </div>
                                            </div>
                                        </td>
                                        <td className="p-4 text-center">
                                            <select className="bg-slate-900 text-white border border-white/10 rounded p-1 text-[9px] outline-none focus:border-[var(--theme-color)]" value={row.asset || ""} onChange={(e) => updateTradeDetail(row.day, 'asset', e.target.value)}>
                                                <option className="bg-[#050b18] text-slate-200" value="">- {t('head_asset')} -</option> {ASSETS.map(a => <option className="bg-[#050b18] text-slate-200" key={a} value={a}>{a}</option>)}
                                            </select>
                                        </td>
                                        <td className="p-4">
                                            <div className="flex justify-center gap-2">
                                                <button onClick={(e)=>commitTrade(row.day,'win', e)} className={`px-3 py-1.5 rounded-lg transition-all font-bold ${row.status==='win'?'bg-[var(--theme-color)] text-black shadow-[0_0_15px_var(--theme-shadow)]':'bg-slate-800 text-slate-500 hover:text-[var(--theme-color)] border border-white/10'}`}>{t('btn_win')}</button>
                                                <button onClick={(e)=>commitTrade(row.day,'loss', e)} className={`px-3 py-1.5 rounded-lg transition-all font-bold ${row.status==='loss'?'bg-rose-500 text-white shadow-[0_0_15px_rgba(244,63,94,0.4)]':'bg-slate-800 text-slate-500 hover:text-rose-400 border border-white/10'}`}>{t('btn_loss')}</button>
                                                {row.status !== 'pending' && <button onClick={()=>{ const j={...cur.journal}; delete j[row.day]; updateCur('journal', j); }} className="text-slate-600 hover:text-white px-2">↺</button>}
                                            </div>
                                        </td>
                                        <td className="p-4 text-center">
                                            <select className="bg-slate-900 text-white border border-white/10 rounded p-1 text-[9px] outline-none focus:border-[var(--theme-color)]" value={row.strategy || ""} onChange={(e) => updateTradeDetail(row.day, 'strategy', e.target.value)}>
                                                <option className="bg-[#050b18] text-slate-200" value="">- {t('head_strat')} -</option> {STRATEGIES.map(s => <option className="bg-[#050b18] text-slate-200" key={s} value={s}>{t('st_' + s.replace(' ', '_').toLowerCase())}</option>)}
                                            </select>
                                        </td>
                                        <td className="p-4 text-center">
                                            <select className={`bg-slate-900 border border-white/10 rounded p-1 text-[9px] outline-none font-bold ${row.grade==='A'?'text-emerald-400':row.grade==='F'?'text-rose-400':'text-white'}`} value={row.grade || ""} onChange={(e) => updateTradeDetail(row.day, 'grade', e.target.value)}>
                                                <option className="bg-[#050b18] text-slate-200" value="">-</option> {GRADES.map(g => <option className="bg-[#050b18] text-slate-200" key={g} value={g}>{g}</option>)}
                                            </select>
                                        </td>
                                        <td className="p-4 text-center">
                                             <select className="bg-slate-900 text-indigo-300 border border-white/10 rounded p-1 text-[9px] outline-none focus:border-indigo-500" value={row.mood || ""} onChange={(e) => updateTradeDetail(row.day, 'mood', e.target.value)}>
                                                <option className="bg-[#050b18] text-slate-200" value="">- {t('head_mood')} -</option> {MOODS.map(m => <option className="bg-[#050b18] text-slate-200" key={m} value={m}>{t('mood_' + m.toLowerCase())}</option>)}
                                            </select>
                                        </td>
                                        <td className="p-4 text-center">
                                            <button onClick={()=>setOpenLogId(row.day)} className={`p-2 rounded-lg transition-all ${row.log ? 'text-[var(--theme-color)] bg-[var(--theme-color)]/10' : 'text-slate-600 hover:text-white'}`}><Icon p={Paths.Edit} s={14}/></button>
                                        </td>
                                        <td className="p-4 text-center">
                                            <button onClick={()=>setOpenImgId(row.day)} className={`p-2 rounded-lg transition-all ${row.screenshot ? 'text-amber-400 bg-amber-500/10' : 'text-slate-600 hover:text-white'}`}><Icon p={Paths.Camera} s={14}/></button>
                                        </td>
                                        <td className={`p-4 text-right font-bold border-l border-white/5 ${row.status==='win'?'text-[var(--theme-color)]':row.status==='loss'?'text-rose-400':'text-slate-600'}`}>{row.status !== 'pending' ? fmt(row.endBal) : '-'}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                        <CaptainLogModal isOpen={!!openLogId} onClose={()=>setOpenLogId(null)} log={openLogId ? (cur.journal[openLogId]?.log || "") : ""} saveLog={(txt)=>updateTradeDetail(openLogId, 'log', txt)} t={t} />
                        <ImageModal isOpen={!!openImgId} onClose={()=>setOpenImgId(null)} url={openImgId ? (cur.journal[openImgId]?.screenshot || "") : ""} onSave={(url)=>updateTradeDetail(openImgId, 'screenshot', url)} t={t} />
                    </div>
                </div>
            );
        };

        const Assistant = ({ aiChat, setAiChat, aiLoading, setAiLoading, apiKey, setApiKey }) => {
            const [msg, setMsg] = useState('');
            const scrollRef = useRef();
            useEffect(() => { scrollRef.current?.scrollTo(0, scrollRef.current.scrollHeight); }, [aiChat]);

            const handleSend = async () => {
                if(!msg.trim() || aiLoading) return;
                if(!apiKey) {
                    setAiChat([...aiChat, { role: 'model', parts: [{ text: "Error: Please enter your Gemini API Key in the settings above." }] }]);
                    return;
                }
                const newChat = [...aiChat, { role: 'user', parts: [{ text: msg }] }];
                setAiChat(newChat); setMsg(''); setAiLoading(true);
                try {
                    const res = await callGeminiLLM(newChat, "คุณคือ QUANTUM Neural Assistant วิเคราะห์กลยุทธ์การเทรด ให้คำแนะนำที่เฉียบคมแบบ Cyberpunk/Sci-Fi ใช้ภาษาทางการบ้างแต่แฝงความเป็น Hacker", apiKey); 
                    setAiChat([...newChat, { role: 'model', parts: [{ text: res }] }]);
                } catch (e) {
                    setAiChat([...newChat, { role: 'model', parts: [{ text: "Neural Link Failure: " + e.message }] }]);
                } finally { setAiLoading(false); }
            };

            return (
                <div className="flex flex-col h-full glass rounded-3xl overflow-hidden border border-cyan-500/20 shadow-2xl animate-fade-in pb-24 lg:pb-0">
                    <div className="p-4 bg-[var(--theme-color)]/10 border-b border-[var(--theme-color)]/20 flex justify-between items-center backdrop-blur-md">
                        <div className="flex items-center gap-2">
                            <div className="w-2 h-2 rounded-full bg-[var(--theme-color)] animate-pulse"></div>
                            <span className="text-[10px] font-bold uppercase tracking-[0.3em] text-[var(--theme-color)]">Quantum Neural Assistant</span>
                        </div>
                        <input type="password" placeholder="Gemini API Key" value={apiKey} onChange={e=>setApiKey(e.target.value)} className="bg-black/40 border border-white/10 rounded px-2 py-1 text-[9px] w-32 outline-none focus:border-[var(--theme-color)] text-[var(--theme-color)]"/>
                    </div>
                    <div ref={scrollRef} className="flex-1 overflow-y-auto p-6 space-y-6 no-scrollbar bg-black/20">
                        {aiChat.map((m, i) => (
                            <div key={i} className={`flex ${m.role==='user'?'justify-end':'justify-start'}`}>
                                <div className={`max-w-[85%] p-4 rounded-2xl text-xs ${m.role==='user'?'bg-[var(--theme-color)] text-black shadow-lg':'bg-slate-900/80 border border-white/5 text-slate-300'}`}>
                                    <div className="prose font-sans" dangerouslySetInnerHTML={{ __html: marked.parse(m.parts[0].text) }} />
                                </div>
                            </div>
                        ))}
                        {aiLoading && <div className="text-[var(--theme-color)] animate-pulse font-mono text-[10px] p-4 uppercase">Processing...</div>}
                    </div>
                    <div className="p-4 bg-black/40 border-t border-white/5 flex gap-3">
                        <input className="flex-1 bg-slate-900/50 border border-white/10 rounded-xl px-4 py-3 text-xs outline-none focus:border-[var(--theme-color)] text-white font-sans transition-all" value={msg} onChange={e=>setMsg(e.target.value)} onKeyDown={e=>e.key==='Enter'&&handleSend()} placeholder="Transmit mission query..."/>
                        <button onClick={handleSend} className="p-3 bg-[var(--theme-color)] rounded-xl text-black shadow-lg shadow-cyan-500/20 hover:opacity-80 transition-all"><Icon p={Paths.Send} s={18}/></button>
                    </div>
                </div>
            );
        };

        const AnalyticsView = ({ stats, cur, apiKey, t }) => {
            const barRef = useRef(null);
            const pieRef = useRef(null);
            const [aiReport, setAiReport] = useState('');
            const [loading, setLoading] = useState(false);

            useEffect(() => {
                if (!barRef.current || !pieRef.current) return;
                
                const style = getComputedStyle(document.body);
                const themeColor = style.getPropertyValue('--theme-color').trim() || '#22d3ee';

                const ctxBar = barRef.current.getContext('2d');
                const barChart = new Chart(ctxBar, {
                    type: 'bar',
                    data: {
                        labels: stats.rows.map(r => r.day),
                        datasets: [{
                            label: 'Daily PnL ($)',
                            data: stats.rows.map(r => r.pnl),
                            backgroundColor: stats.rows.map(r => r.pnl >= 0 ? themeColor+'99' : '#f43f5e99'),
                            borderColor: stats.rows.map(r => r.pnl >= 0 ? themeColor : '#f43f5e'),
                            borderWidth: 1,
                            borderRadius: 4
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { grid: { display: false }, ticks: { color: '#94a3b8', font: {size: 8} } }, y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#94a3b8', font: {size: 8} } } } }
                });

                const ctxPie = pieRef.current.getContext('2d');
                const pieChart = new Chart(ctxPie, {
                    type: 'doughnut',
                    data: {
                        labels: ['Wins', 'Losses', 'Pending'],
                        datasets: [{
                            data: [stats.wins, stats.losses, cur.config.days - (stats.wins + stats.losses)],
                            backgroundColor: [themeColor, '#f43f5e', 'rgba(148, 163, 184, 0.1)'],
                            borderWidth: 0,
                            hoverOffset: 4
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { display: false } } }
                });

                return () => { barChart.destroy(); pieChart.destroy(); };
            }, [stats, cur]);

            const getAiDebrief = async () => {
                if(!apiKey) {
                    setAiReport("Error: Please set API Key in Neural Link first.");
                    return;
                }
                setLoading(true);
                const strategySummary = stats.rows
                    .filter(r => r.status !== 'pending' && r.strategy)
                    .map(r => `${r.strategy}: ${r.status}`)
                    .join(', ');

                const dataSummary = `Trading Portfolio: ${cur.name}. Win Rate: ${stats.wr}%. Profit Factor: ${stats.pf}. Avg Discipline: ${stats.avgDisc}/5. Equity: ${fmt(stats.final)}. Risk per trade: ${cur.config.risk}%. Target RR: ${cur.config.rr}. Strategy Log: [${strategySummary}]`;
                
                try {
                    const res = await callGeminiLLM([{role:'user', parts:[{text: `Analyze this data: ${dataSummary}`}]}], "คุณคือ Quantum Mind Strategist วิเคราะห์ข้อมูลการเทรดนี้ และให้คำแนะนำเชิงลึก (Debrief) แบบ Hacker/Sci-Fi ที่เฉียบคมมาก สรุปเป็นหัวข้อสั้นๆ และให้กำลังใจหรือเตือนสติ โดยเฉพาะเรื่อง Strategy ที่ใช้", apiKey);
                    setAiReport(res);
                } catch (e) { setAiReport("Connection Failed: " + e.message); }
                finally { setLoading(false); }
            };

            return (
                <div className="h-full flex flex-col gap-6 animate-fade-in overflow-y-auto no-scrollbar pb-24 lg:pb-0">
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6 h-64 shrink-0">
                        <div className="md:col-span-2 glass-card p-5 rounded-3xl flex flex-col">
                            <h3 className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-4 flex items-center gap-2">
                                <Icon p={Paths.Chart} s={14}/> {t('txt_perf_matrix')}
                            </h3>
                            <div className="flex-1 relative min-h-0">
                                <canvas ref={barRef}></canvas>
                            </div>
                        </div>

                        <div className="glass-card p-5 rounded-3xl flex flex-col items-center justify-center relative">
                            <div className="absolute inset-0 flex items-center justify-center pointer-events-none flex-col">
                                <div className="text-3xl font-mono font-bold text-white">{stats.wr.toFixed(0)}%</div>
                                <div className="text-[8px] uppercase text-slate-500 tracking-widest">{t('txt_win_rate')}</div>
                            </div>
                            <div className="w-40 h-40 relative z-10">
                                <canvas ref={pieRef}></canvas>
                            </div>
                        </div>
                    </div>

                    <Heatmap stats={stats} days={cur.config.days} t={t} />

                    <div className="glass-card p-6 rounded-3xl border border-cyan-500/20">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="text-[10px] font-bold text-[var(--theme-color)] uppercase tracking-widest flex items-center gap-2">
                                <Icon p={Paths.Brain} s={16}/> Neural Mission Debrief
                            </h3>
                            <button onClick={getAiDebrief} disabled={loading} className={`px-4 py-2 rounded-xl bg-[var(--theme-color)] text-black font-bold text-[10px] uppercase tracking-widest flex items-center gap-2 transition-all ${loading?'opacity-50':'hover:opacity-80 ai-pulse'}`}>
                                {loading ? 'Processing...' : `✨ ${t('btn_ai_analysis')}`}
                            </button>
                        </div>
                        {aiReport ? (
                            <div className="prose prose-invert max-w-none font-sans text-xs bg-black/30 p-6 rounded-2xl border border-white/5 animate-slide-in" dangerouslySetInnerHTML={{ __html: marked.parse(aiReport) }} />
                        ) : (
                            <div className="text-center py-10 text-slate-600 italic text-[10px] uppercase tracking-widest">{t('txt_connect_core')}</div>
                        )}
                    </div>
                </div>
            );
        };

        const ZenOverlay = ({ onClose, setRun, run, sec, setSec }) => {
            useEffect(() => {
                let i; if(run && sec > 0) i = setInterval(()=>setSec(s=>s-1), 1000);
                return () => clearInterval(i);
            }, [run, sec]);

            useEffect(() => {
                if (!run) return;
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const bufferSize = ctx.sampleRate * 2;
                const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
                const data = buffer.getChannelData(0);
                let lastOut = 0;
                for (let i = 0; i < bufferSize; i++) {
                    const white = Math.random() * 2 - 1;
                    data[i] = (lastOut + (0.02 * white)) / 1.02;
                    lastOut = data[i];
                    data[i] *= 3.5;
                }
                const noise = ctx.createBufferSource();
                noise.buffer = buffer;
                noise.loop = true;
                const gainNode = ctx.createGain();
                gainNode.gain.value = 0.05;
                noise.connect(gainNode);
                gainNode.connect(ctx.destination);
                noise.start();
                gainNode.gain.setValueAtTime(0, ctx.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.08, ctx.currentTime + 2);
                return () => {
                    gainNode.gain.linearRampToValueAtTime(0, ctx.currentTime + 1);
                    noise.stop(ctx.currentTime + 1);
                    setTimeout(() => ctx.close(), 1200);
                };
            }, [run]);

            return (
                <div className="fixed inset-0 z-[200] bg-black/95 backdrop-blur-2xl flex items-center justify-center animate-fade-in p-10 text-center">
                    <div className="max-w-md">
                        <h2 className="text-[var(--theme-color)] font-sci font-bold tracking-[0.5em] mb-12 uppercase animate-pulse">Neural Synchronization</h2>
                        <div className="text-9xl font-mono font-bold text-white mb-16 relative">
                            {Math.floor(sec/60)}:{(sec%60).toString().padStart(2,'0')}
                            {run && <div className="absolute inset-0 border-8 border-[var(--theme-color)]/20 rounded-full animate-ring scale-150"></div>}
                        </div>
                        <div className="flex gap-6 justify-center">
                            <button onClick={()=>setRun(!run)} className={`px-12 py-4 rounded-2xl font-bold tracking-widest transition-all ${run?'bg-rose-500/20 text-rose-400':'bg-[var(--theme-color)] text-black shadow-[0_0_30px_var(--theme-color)]'}`}>{run?'TERMINATE':'INITIATE'}</button>
                            <button onClick={onClose} className="px-12 py-4 border border-white/10 rounded-2xl text-slate-500 hover:text-white">CLOSE LINK</button>
                        </div>
                        {run && <div className="mt-8 text-[10px] text-[var(--theme-color)]/50 uppercase tracking-widest animate-pulse">Ambient Neural Drone Active</div>}
                    </div>
                </div>
            );
        };

        // --- SIDEBAR DRAWER ---
        const SidebarOverlay = ({ isOpen, onClose, setView, activePortId, setActivePortId, portfolios, createPort, deletePort, setZenActive, handleExportCSV, handleExportExcel, handleImport, t, lang, setLang }) => {
            return (
                <div className={`fixed inset-0 z-50 sidebar-overlay ${isOpen ? 'sidebar-open' : 'sidebar-closed'}`}>
                    <div className="absolute inset-0 bg-black/80 backdrop-blur-sm transition-opacity duration-300" onClick={onClose}></div>
                    <div className="absolute top-0 bottom-0 left-0 w-3/4 max-w-xs bg-[#050b18]/90 backdrop-blur-xl border-r border-cyan-500/30 shadow-[0_0_50px_rgba(6,182,212,0.2)] flex flex-col sidebar-content">
                        <div className="h-20 flex items-center justify-between px-6 border-b border-white/5 bg-cyan-900/10">
                            <div className="flex items-center">
                                <div className="p-2 bg-[var(--theme-color)] rounded-lg text-black shadow-[0_0_20px_var(--theme-shadow)]"><Icon p={Paths.Atom} s={24}/></div>
                                <span className="ml-4 font-sci font-bold text-sm tracking-[0.3em] text-white">QUANTUM <span className="text-[var(--theme-color)]">Ω</span></span>
                            </div>
                            <button onClick={onClose} className="p-2 rounded-full bg-white/5 text-slate-400 hover:text-white"><Icon p={Paths.Close} s={18}/></button>
                        </div>

                        <nav className="flex-1 p-6 space-y-2 overflow-y-auto">
                            {[
                                {id:'terminal', l:t('nav_terminal'), i:Paths.Terminal},
                                {id:'journal', l:t('nav_journal'), i:Paths.Journal},
                                {id:'calendar', l:t('nav_calendar'), i:Paths.Calendar},
                                {id:'neural', l:t('nav_neural'), i:Paths.Brain},
                                {id:'stats', l:t('nav_stats'), i:Paths.Chart},
                                {id:'news', l:t('nav_news'), i:Paths.Globe}, 
                                {id:'chart', l:t('nav_chart'), i:Paths.Chart}, 
                            ].map(m => (
                                <button key={m.id} onClick={()=>{ setView(m.id); onClose(); }} className="w-full flex items-center p-4 rounded-2xl text-slate-400 hover:text-white hover:bg-white/5 transition-all border border-transparent hover:border-[var(--theme-color)]/20 group">
                                    <Icon p={m.i} s={20} cls="group-hover:text-[var(--theme-color)] transition-colors" /> <span className="ml-4 font-bold uppercase tracking-widest text-xs">{m.l}</span>
                                </button>
                            ))}
                            <div className="h-px bg-white/5 my-4"></div>
                            <button onClick={()=>{ setZenActive(true); onClose(); }} className="w-full flex items-center p-4 rounded-2xl text-indigo-400 hover:bg-indigo-500/10 transition-all border border-indigo-500/20">
                                <Icon p={Paths.Pulse} s={20}/> <span className="ml-4 font-bold uppercase tracking-widest text-xs">{t('nav_zen')}</span>
                            </button>
                        </nav>

                        <div className="p-6 bg-black/40 border-t border-white/5">
                            <div className="text-[9px] text-[var(--theme-color)] uppercase tracking-widest mb-2 font-bold">{t('data_profile')}</div>
                            
                            <div className="grid grid-cols-2 gap-2 mb-4">
                                <button onClick={handleExportCSV} className="flex-1 py-3 bg-white/5 hover:bg-white/10 rounded-lg text-[9px] uppercase font-bold text-slate-300 flex flex-col items-center gap-1 transition-all">
                                    <Icon p={Paths.Csv} s={16} /> CSV
                                </button>
                                <button onClick={handleExportExcel} className="flex-1 py-3 bg-emerald-500/10 hover:bg-emerald-500/20 rounded-lg text-[9px] uppercase font-bold text-emerald-400 flex flex-col items-center gap-1 transition-all">
                                    <Icon p={Paths.Excel} s={16} /> Excel
                                </button>
                            </div>

                            <label className="w-full flex items-center justify-center gap-2 py-3 border border-dashed border-[var(--theme-color)]/30 rounded-xl text-[9px] uppercase font-bold text-[var(--theme-color)] cursor-pointer hover:bg-[var(--theme-color)]/10 transition-all mb-4">
                                <Icon p={Paths.Import} s={16}/> {t('btn_import')}
                                <input type="file" className="hidden" onChange={handleImport} accept=".json"/>
                            </label>

                            {/* Language Switcher in Sidebar */}
                            <div className="mb-4">
                                <div className="text-[8px] text-slate-500 font-bold uppercase mb-2">{t('lang_sel')}</div>
                                <div className="flex bg-slate-900 rounded-lg p-1 border border-white/10">
                                    <button onClick={()=>setLang('en')} className={`flex-1 py-1 text-[9px] font-bold rounded ${lang==='en'?'bg-[var(--theme-color)] text-black':'text-slate-400 hover:text-white'}`}>EN</button>
                                    <button onClick={()=>setLang('th')} className={`flex-1 py-1 text-[9px] font-bold rounded ${lang==='th'?'bg-[var(--theme-color)] text-black':'text-slate-400 hover:text-white'}`}>TH</button>
                                </div>
                            </div>

                            <select value={activePortId} onChange={e=>setActivePortId(Number(e.target.value))} className="w-full bg-slate-900 border border-white/10 rounded-xl p-3 text-xs text-white outline-none mb-3">
                                {Object.values(portfolios).map(p=><option key={p.id} value={p.id}>{p.name}</option>)}
                            </select>
                            <div className="flex gap-2">
                                <button onClick={createPort} className="flex-1 py-3 bg-[var(--theme-color)]/20 hover:bg-[var(--theme-color)]/40 text-[var(--theme-color)] rounded-lg text-[10px] uppercase font-bold border border-[var(--theme-color)]/30 transition-all">{t('btn_new')}</button>
                                <button onClick={()=>deletePort(activePortId)} className="flex-1 py-3 bg-rose-500/10 hover:bg-rose-500/20 text-rose-400 rounded-lg text-[10px] uppercase font-bold border border-rose-500/30 transition-all">{t('btn_delete')}</button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- MAIN APP ---

        const App = () => {
            const [view, setView] = useState('terminal');
            const [isMobile, setIsMobile] = useState(window.innerWidth < 1024);
            const [showSidebar, setShowSidebar] = useState(false);
            const [theme, setTheme] = useState('theme-cyan'); 
            const [panicMode, setPanicMode] = useState(false); 
            const [riskCalc, setRiskCalc] = useState(false);
            const [checklistActive, setChecklistActive] = useState(false);
            const [lang, setLang] = useState('en'); // Language State
            
            // Helper function for translations
            const t = (key) => TRANSLATIONS[lang][key] || key;

            useEffect(() => {
                const handleResize = () => { const mobile = window.innerWidth < 1024; setIsMobile(mobile); };
                window.addEventListener('resize', handleResize);
                document.body.className = theme; 
                return () => window.removeEventListener('resize', handleResize);
            }, [theme]);

            const [activePortId, setActivePortId] = useState(1);
            const [portfolios, setPortfolios] = useState({ 1: { id: 1, name: 'Alpha Core', config: { bal: 1000, risk: 2, rr: 2, days: 30, slPips: 50, startDate: new Date().toISOString().split('T')[0] }, journal: {}, withdrawn: 0, goal: { name: 'New Reward', amount: 500 }, xp: 0 } });
            const [isSound, setIsSound] = useState(true);
            const [zenActive, setZenActive] = useState(false);
            const [aiChat, setAiChat] = useState([{ role: 'model', parts: [{ text: "Neural Link Online. Systems operational." }] }]);
            const [aiLoading, setAiLoading] = useState(false);
            const [apiKey, setApiKey] = useState('');
            const [zenSec, setZenSec] = useState(300);
            const [zenRun, setZenRun] = useState(false);
            const [aiForecast, setAiForecast] = useState('');
            const [forecastLoading, setForecastLoading] = useState(false);

            const cur = portfolios[activePortId] || Object.values(portfolios)[0];
            
            useEffect(() => {
                const saved = localStorage.getItem('fm_omega_singularity_v5_stable');
                if(saved) {
                    const parsed = JSON.parse(saved);
                    setPortfolios(parsed.portfolios);
                    setActivePortId(parsed.activeId);
                    if(parsed.apiKey) setApiKey(parsed.apiKey);
                    if(parsed.lang) setLang(parsed.lang);
                    if(parsed.theme) setTheme(parsed.theme); // PERSIST THEME
                }
            }, []);

            useEffect(() => {
                localStorage.setItem('fm_omega_singularity_v5_stable', JSON.stringify({ portfolios, activeId: activePortId, apiKey, lang, theme })); // SAVE THEME
            }, [portfolios, activePortId, apiKey, lang, theme]);

            const updateCur = (key, val) => {
                setPortfolios(prev => ({ ...prev, [activePortId]: { ...prev[activePortId], [key]: val } }));
            };

            const commitTrade = (day, status, event) => {
                const prev = cur.journal[day] || {};
                let xpGain = 0;
                if(status === 'win' && prev.status !== 'win') {
                    playSound('win', isSound); xpGain = 100; window.warpActive = true;
                    if(event) window.triggerExplosion(event.clientX, event.clientY, '#22d3ee');
                    setTimeout(() => window.warpActive = false, 3000);
                } else if(status === 'loss' && prev.status !== 'loss') {
                    playSound('loss', isSound); xpGain = 10;
                }
                const newJ = { ...cur.journal, [day]: { ...prev, status, discipline: prev.discipline || 5 } };
                setPortfolios(p => ({ ...p, [activePortId]: { ...cur, journal: newJ, xp: (cur.xp || 0) + xpGain } }));
            };

            const updateTradeDetail = (day, field, value) => {
                const prev = cur.journal[day] || { status: 'pending' };
                const newJ = { ...cur.journal, [day]: { ...prev, [field]: value } };
                setPortfolios(p => ({ ...p, [activePortId]: { ...cur, journal: newJ } }));
            };

            const createPort = () => {
                const name = prompt("Enter Portfolio Name:");
                if(!name) return;
                const id = Date.now();
                setPortfolios(p => ({ ...p, [id]: { id, name, config: { bal: 1000, risk: 2, rr: 2, days: 30, slPips: 50, startDate: new Date().toISOString().split('T')[0] }, journal: {}, withdrawn: 0, goal: { name: 'Reward', amount: 500 }, xp: 0 } }));
                setActivePortId(id);
            };

            const deletePort = (id) => {
                if(Object.keys(portfolios).length <= 1) return;
                if(confirm("Terminate this portfolio? Data will be vaporized.")) {
                    const newP = { ...portfolios }; delete newP[id];
                    setPortfolios(newP); setActivePortId(Object.keys(newP)[0]);
                }
            };

            const stats = useMemo(() => {
                let bal = cur.config.bal;
                let peak = bal; 
                let maxDD = 0; 
                let wins=0, losses=0, profit=0, lossVal=0, discSum=0, discCnt=0;
                const rows = [];
                const equity = [{x: 0, y: bal}];
                const highWaterMark = [{x:0, y:bal}]; 

                let currentStreak = 0; 

                for(let i=1; i<=cur.config.days; i++) {
                    const d = cur.journal[i] || { status: 'pending', discipline: 0 };
                    const startBal = bal;
                    const riskAmt = startBal * (cur.config.risk/100);
                    const rewardAmt = riskAmt * cur.config.rr;
                    const slPips = cur.config.slPips || 50;
                    const lotSize = riskAmt / (slPips * 10);
                    let pnl = 0;

                    if(d.status === 'win') { 
                        pnl = rewardAmt; profit += pnl; wins++; 
                        currentStreak = currentStreak >= 0 ? currentStreak + 1 : 1;
                    } 
                    else if(d.status === 'loss') { 
                        pnl = -riskAmt; lossVal += riskAmt; losses++; 
                        currentStreak = currentStreak <= 0 ? currentStreak - 1 : -1;
                    }

                    if(d.status !== 'pending') { 
                        bal += pnl; 
                        discSum += (d.discipline || 0); 
                        discCnt++; 
                        equity.push({x: i, y: bal}); 
                        
                        if (bal > peak) peak = bal;
                        const dd = (peak - bal) / peak * 100;
                        if (dd > maxDD) maxDD = dd;
                    }
                    highWaterMark.push({x: i, y: peak});
                    rows.push({ day: i, startBal, riskAmt, rewardAmt, lotSize, pnl, endBal: bal, ...d });
                }

                const wr = (wins+losses) > 0 ? (wins/(wins+losses))*100 : 0;
                const pf = lossVal > 0 ? profit/lossVal : (profit > 0 ? 10 : 0);
                const avgDisc = discCnt > 0 ? discSum/discCnt : 0;
                const level = Math.floor(Math.sqrt((cur.xp||0)/100)) + 1;
                const progress = ((cur.xp||0) % 100);

                const final = bal - (cur.withdrawn || 0);
                const winProb = wr / 100;
                const lossProb = 1 - winProb;
                const rewardRatio = cur.config.rr; 
                const expectancy = (winProb * rewardRatio) - lossProb;
                let survivalProb = 0;
                if (expectancy > 0) survivalProb = 99.9; 
                else if (wins+losses === 0) survivalProb = 100; 
                else survivalProb = Math.max(0, 100 - (Math.abs(expectancy) * 500)); 

                return { final, wins, losses, wr, pf, avgDisc, equity, rows, level, progress, maxDD, currentStreak, survivalProb, highWaterMark };
            }, [cur]);

            const getForecast = async () => {
                if(!apiKey) {
                    setAiForecast("Error: Please set API Key in Neural Link first.");
                    return;
                }
                setForecastLoading(true);
                const context = `Balance: ${fmt(cur.config.bal)}. WinRate: ${stats.wr}%. Current Goal: ${fmt(cur.goal.amount)}. Target RR: ${cur.config.rr}. Risk: ${cur.config.risk}%.`;
                try {
                    const res = await callGeminiLLM([{role:'user', parts:[{text: `Calculate forecast for: ${context}`}]}], "คุณคือ Strategic Forecasting AI วิเคราะห์ข้อมูลนี้และวางแผนการเทรดสั้นๆ ให้บรรลุเป้าหมาย ใช้ภาษา Hacker/Sci-Fi", apiKey);
                    setAiForecast(res);
                } catch (e) { setAiForecast("Connection Error: " + e.message); }
                finally { setForecastLoading(false); }
            };

            const handleExportCSV = () => {
                let csv = "Day,Start Balance,Risk($),Reward($),Outcome,Asset,Strategy,Grade,Mood,Note,End Balance\n";
                stats.rows.forEach(r => csv += `${r.day},${r.startBal.toFixed(2)},${r.riskAmt.toFixed(2)},${r.rewardAmt.toFixed(2)},${r.status},${r.asset||''},${r.strategy||''},${r.grade||''},${r.mood||''},"${r.log||''}",${r.endBal.toFixed(2)}\n`);
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = `Quantum_Omega_${cur.name}.csv`; a.click();
            };

            const handleExportExcel = () => {
                const wb = XLSX.utils.book_new();
                const wsData = [
                    ["Day", "Start Balance", "Risk ($)", "Reward ($)", "Lot Size", "Outcome", "Asset", "Strategy", "Grade", "Mood", "Log", "End Balance"],
                    ...stats.rows.map(r => [
                        r.day,
                        r.startBal,
                        r.riskAmt,
                        r.rewardAmt,
                        r.lotSize,
                        r.status,
                        r.asset || '',
                        r.strategy || '',
                        r.grade || '',
                        r.mood || '',
                        r.log || '',
                        r.endBal
                    ])
                ];
                const ws = XLSX.utils.aoa_to_sheet(wsData);
                XLSX.utils.book_append_sheet(wb, ws, "Mission Logs");
                XLSX.writeFile(wb, `Quantum_Omega_${cur.name}.xlsx`);
            };

            const handleImport = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (data.portfolios) {
                            setPortfolios(data.portfolios);
                            setActivePortId(data.activeId || Object.keys(data.portfolios)[0]);
                            alert("Backup restored successfully. Welcome back, Commander.");
                        } else {
                            alert("Invalid backup file structure.");
                        }
                    } catch (err) {
                        alert("Error parsing backup file.");
                    }
                };
                reader.readAsText(file);
            };

            const handleBackup = () => {
                const data = JSON.stringify({ portfolios, activeId: activePortId, apiKey, lang, theme });
                const blob = new Blob([data], { type: 'application/json' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = `Quantum_Omega_Backup_${new Date().toISOString().slice(0,10)}.json`; a.click();
            };

            const handleSnapshot = () => {
                alert("Snapshot Protocol Initiated: Press PrintScreen/Capture now to save this state.");
            };

            return (
                <div className={`flex h-screen text-xs relative z-10 font-sans selection:bg-[var(--theme-color)]/30 ${panicMode ? 'panic-blur' : ''}`}>
                    <SidebarOverlay 
                        isOpen={showSidebar} 
                        onClose={()=>setShowSidebar(false)} 
                        setView={setView} 
                        activePortId={activePortId} 
                        setActivePortId={setActivePortId} 
                        portfolios={portfolios} 
                        createPort={createPort} 
                        deletePort={deletePort} 
                        setZenActive={setZenActive}
                        handleExportCSV={handleExportCSV}
                        handleExportExcel={handleExportExcel}
                        handleImport={handleImport}
                        t={t}
                        lang={lang}
                        setLang={setLang}
                    />

                    <main className="flex-1 flex flex-col overflow-hidden relative"> 
                        <header className="h-16 lg:h-20 border-b border-white/10 glass flex items-center justify-between px-6 z-20 relative">
                            <div className="flex items-center gap-4">
                                <button onClick={()=>setShowSidebar(true)} className="p-2 rounded-xl bg-white/5 text-[var(--theme-color)] border border-white/10 hover:bg-white/10 active:scale-95 transition-all">
                                    <Icon p={Paths.Menu} s={20}/>
                                </button>
                                <h2 className="text-sm lg:text-xl font-sci font-bold text-white tracking-[0.2em] uppercase neon-text">{t(view === 'terminal' ? 'nav_terminal' : view === 'journal' ? 'nav_journal' : view === 'neural' ? 'nav_neural' : view === 'news' ? 'nav_news' : view === 'chart' ? 'nav_chart' : view === 'calendar' ? 'nav_calendar' : 'nav_stats')}</h2>
                                <SessionClocks t={t} />
                            </div>
                            <div className="flex items-center gap-4">
                                <button onClick={()=>setChecklistActive(true)} className={`p-2 rounded-lg transition-all border ${checklistActive ? 'bg-[var(--theme-color)] text-black border-[var(--theme-color)]' : 'border-white/10 text-slate-400 hover:text-white'}`} title="Launch Sequence Checklist">
                                    <Icon p={Paths.Rocket} s={16}/>
                                </button>

                                <button onClick={()=>setRiskCalc(true)} className={`p-2 rounded-lg transition-all border ${riskCalc ? 'bg-[var(--theme-color)] text-black border-[var(--theme-color)]' : 'border-white/10 text-slate-400 hover:text-white'}`} title="Risk Calculator">
                                    <Icon p={Paths.Shield} s={16}/>
                                </button>

                                <button onClick={handleSnapshot} className="p-2 rounded-lg transition-all border border-white/10 text-slate-400 hover:text-white hover:bg-white/5" title="Snapshot">
                                    <Icon p={Paths.Camera} s={16}/>
                                </button>

                                <button onClick={()=>setPanicMode(true)} className="p-2 bg-red-500/10 border border-red-500/50 text-red-500 rounded-lg hover:bg-red-500 hover:text-white transition-all font-bold text-[9px] uppercase tracking-widest flex items-center gap-2 animate-pulse" title="PANIC PROTOCOL">
                                    <Icon p={Paths.Alert} s={14}/> Panic
                                </button>
                                
                                <ThemeSwitcher current={theme} set={setTheme} />

                                {!isMobile && (
                                    <div className="text-right">
                                        <div className="text-[9px] text-slate-500 uppercase font-bold tracking-widest">{t('txt_global_liq')}</div>
                                        <div className="text-lg lg:text-2xl font-mono font-bold text-[var(--theme-color)]">{fmt(stats.final)}</div>
                                    </div>
                                )}
                                <button onClick={()=>setIsSound(!isSound)} className={`p-3 rounded-xl transition-all ${isSound?'bg-[var(--theme-color)]/10 text-[var(--theme-color)]':'text-slate-700'}`}>
                                    <Icon p={isSound?Paths.SoundOn:Paths.SoundOff} s={18}/>
                                </button>
                            </div>
                        </header>

                        <div className="flex-1 p-4 lg:p-8 overflow-y-auto no-scrollbar relative">
                            {view === 'terminal' && (
                                <div className="grid grid-cols-1 lg:grid-cols-4 gap-6 animate-fade-in pb-24 lg:pb-0">
                                    <div className="lg:col-span-3 space-y-6">
                                        <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                                            {[
                                                {l:t('stat_pf'),v:stats.pf.toFixed(2),c:'cyan'},
                                                {l:t('stat_disc'),v:stats.avgDisc.toFixed(1),c:'indigo'},
                                                {l:t('stat_wins'),v:stats.wins,c:'emerald'},
                                                {l:t('stat_losses'),v:stats.losses,c:'rose'},
                                                {l:t('stat_dd'),v:`-${stats.maxDD.toFixed(1)}%`,c:'amber'},
                                                {l:t('stat_surv'),v:`${stats.survivalProb.toFixed(0)}%`,c:'blue'}
                                            ].map(i=>(
                                                <div key={i.l} className="glass-card p-4 rounded-3xl">
                                                    <div className="text-[8px] uppercase text-slate-500 font-bold mb-1">{i.l}</div>
                                                    <div className={`text-xl font-mono font-bold text-${i.c}-400`}>{i.v}</div>
                                                </div>
                                            ))}
                                        </div>
                                        
                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                            <TimeDilation t={t} />
                                            <div className="glass-card p-6 rounded-3xl border border-indigo-500/20 col-span-1 md:col-span-1">
                                                <div className="flex justify-between items-center mb-4">
                                                    <h3 className="text-[9px] font-bold text-slate-400 uppercase tracking-widest">{t('txt_ai_strat')}</h3>
                                                    <button onClick={getForecast} disabled={forecastLoading} className="px-3 py-1 bg-indigo-600 text-white rounded-lg text-[9px] font-bold uppercase hover:bg-indigo-500 transition-all ai-pulse">
                                                        {forecastLoading ? '...' : t('btn_forecast')}
                                                    </button>
                                                </div>
                                                {aiForecast ? (
                                                    <div className="prose prose-invert prose-sm text-[10px] bg-black/40 p-3 rounded-xl border border-white/5 h-32 overflow-y-auto" dangerouslySetInnerHTML={{ __html: marked.parse(aiForecast) }} />
                                                ) : <div className="text-[10px] text-slate-600 text-center mt-8">No active forecast</div>}
                                            </div>
                                        </div>

                                        <div className="glass-card p-8 rounded-[2rem] min-h-[300px]"><TradeChart equityData={stats.equity} highWaterMark={stats.highWaterMark} /></div>
                                    </div>
                                    <div className="lg:col-span-1 space-y-6">
                                        <RadarDNA stats={stats} cur={cur} t={t} />
                                        <RewardCard cur={cur} updateCur={updateCur} fmt={fmt} isSound={isSound} t={t} />
                                        <button onClick={handleBackup} className="w-full p-4 border border-[var(--theme-color)]/20 rounded-2xl flex items-center justify-center gap-3 text-[var(--theme-color)] font-bold uppercase text-[10px] hover:bg-[var(--theme-color)]/5 transition-all">
                                            <Icon p={Paths.Export} s={18}/> {t('btn_backup')}
                                        </button>
                                    </div>
                                </div>
                            )}

                            {view === 'journal' && <MissionLog cur={cur} stats={stats} updateCur={updateCur} commitTrade={commitTrade} updateTradeDetail={updateTradeDetail} t={t} isMobile={isMobile} />}
                            {view === 'calendar' && <PnLCalendar cur={cur} stats={stats} t={t} lang={lang} />}
                            {view === 'neural' && <Assistant aiChat={aiChat} setAiChat={setAiChat} aiLoading={aiLoading} setAiLoading={setAiLoading} apiKey={apiKey} setApiKey={setApiKey} />}
                            {view === 'stats' && <AnalyticsView stats={stats} cur={cur} apiKey={apiKey} t={t} />}
                            {view === 'news' && <NewsTerminal lang={lang} />}
                            {view === 'chart' && <MarketChart theme={theme} lang={lang} />}
                        </div>
                    </main>

                    {zenActive && <ZenOverlay onClose={()=>setZenActive(false)} run={zenRun} setRun={setZenRun} sec={zenSec} setSec={setZenSec} />}
                    <PanicOverlay active={panicMode} close={()=>setPanicMode(false)} />
                    
                    <RiskCalculator active={riskCalc} close={()=>setRiskCalc(false)} t={t} />
                    <ChecklistModal active={checklistActive} close={()=>setChecklistActive(false)} t={t} />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
